<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ì¹˜ë£Œì‹¤ íƒ€ì´ë¨¸ ë³´ë“œ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --purple: #4b0082;
      --yellow: #ffe08a;
      --red: #ff9e9e;
      --dept-rep: #ffd9a3;
      --dept-west: #b6dcff;
      --dept-1: #d7c7ff;
      --dept-2: #c7ffd6;
      --dept-3: #ffc7eb;
    }
    body {
      font-family: "Noto Sans KR", sans-serif;
      background: #f0f2f5;
      margin: 0;
      padding: 100px 20px 60px 20px;
    }
    h2 { margin: 0 0 16px; }
    .toolbar { display:flex; gap:8px; align-items:center; margin-bottom:14px; }
    .toolbar input { padding:6px 8px; font-size:14px; border:1px solid #ccc; border-radius:6px; width:80px; }
    .btn { border:none; border-radius:6px; padding:6px 12px; font-size:14px; cursor:pointer; }
    .btn-apply { background:#007bff; color:#fff; }

    table { width:100%; border-collapse:collapse; background:#fff; box-shadow:0 2px 8px rgba(0,0,0,0.04); }
    thead { background:var(--purple); color:#fff; }
    th, td { border:1px solid #e5e5e5; padding:10px 8px; text-align:center; font-size:14px; }
    th:nth-child(1){ width:120px; }
    th:nth-child(2){ width:170px; text-align:left; }
    td:nth-child(2){ text-align:left; }

    .status-box{ display:flex; flex-direction:column; gap:8px; align-items:center; justify-content:center; }
    .pill{ display:inline-block; padding:4px 12px; border-radius:999px; font-size:13px; font-weight:600; }
    .pill-wait{ background:#fff; border:1.5px solid #ddd; }
    .pill-run{ background:var(--yellow); }
    .pill-done{ background:#ff9e9e; }
    .time-text{ font-weight:700; color:#d9534f; font-size:16px; }
    .mini-btn{ border:none; border-radius:6px; padding:4px 10px; font-size:12px; cursor:pointer; }
    .mini-start{ background:#0d6efd; color:#fff; }
    .mini-stop{ background:#ffc107; }
    .adjust-box{ display:flex; gap:6px; }
    .btn-adjust{ background:#fff; border:1px solid #bbb; border-radius:6px; width:32px; height:28px; line-height:24px; text-align:center; cursor:pointer; font-size:18px; }
    select.doctor{ width:130px; padding:6px 8px; border-radius:8px; border:1px solid #bbb; font-size:14px; background:#fff; }

    .nurse-panel{
      position:fixed; top:12px; right:12px; background:rgba(255,255,255,0.98);
      border:2px solid #cfcfcf; border-radius:999px; padding:10px 14px; box-shadow:0 10px 26px rgba(0,0,0,0.12);
      display:flex; gap:14px; align-items:center; z-index:999;
    }
    .nurse-label{ font-size:16px; font-weight:800; margin-right:4px; white-space:nowrap; }
    .btn-call{ border:none; border-radius:999px; padding:10px 18px; font-size:15px; cursor:pointer; background:#f2f3f5; font-weight:700; white-space:nowrap; letter-spacing:.2px; box-shadow:0 2px 6px rgba(0,0,0,0.06); }
    .btn-call.on{ outline:3px solid #ff4d4f; background:#ffe6e6; }

    @keyframes blinkRow{0%{filter:brightness(1)}50%{filter:brightness(1.45)}100%{filter:brightness(1)}}
    @keyframes blinkBtn{0%{background:#ffe6e6;transform:translateY(0)}50%{background:#ffb3b3;transform:translateY(-1px)}100%{background:#ffe6e6;transform:translateY(0)}}
    .blink-row{ animation:blinkRow .8s linear infinite; }
    .blink-btn{ animation:blinkBtn .7s ease-in-out infinite; }
  </style>
</head>
<body>
  <h2>ğŸ¥ ì¹˜ë£Œì‹¤ íƒ€ì´ë¨¸íŒ (12ë³‘ìƒ)</h2>

  <div class="toolbar">
    <span>ê¸°ë³¸ ì‹œê°„(ë¶„):</span>
    <input type="number" id="defaultMinutes" value="10" min="1" />
    <button class="btn btn-apply" onclick="applyDefaultMinutes()">ì ìš©</button>
    <small style="color:#666;">ì¶”ë‚˜ëŠ” 5ë¶„ ê³ ì • / ê° ì¹¸ì—ì„œ ï¼‹ï¼ë¡œ ì¡°ì •</small>
  </div>

  <table id="timerTable">
    <thead>
      <tr>
        <th>ë‹´ë‹¹</th>
        <th>í™˜ìì´ë¦„</th>
        <th>í•«íŒ©</th>
        <th>ë¬¼ë¦¬ì¹˜ë£Œ</th>
        <th>ì¹¨ì¹˜ë£Œ</th>
        <th>ì¶”ë‚˜</th>
      </tr>
    </thead>
    <tbody id="tableBody"></tbody>
  </table>

  <div class="nurse-panel">
    <span class="nurse-label">ê°„í˜¸ì‚¬ í˜¸ì¶œ</span>
    <button class="btn-call" id="call-ëŒ€í‘œ" onclick="toggleCall('ëŒ€í‘œ')">ëŒ€í‘œ</button>
    <button class="btn-call" id="call-ì–‘ë°©" onclick="toggleCall('ì–‘ë°©')">ì–‘ë°©</button>
    <button class="btn-call" id="call-1ê³¼" onclick="toggleCall('1ê³¼')">1ê³¼</button>
    <button class="btn-call" id="call-2ê³¼" onclick="toggleCall('2ê³¼')">2ê³¼</button>
    <button class="btn-call" id="call-3ê³¼" onclick="toggleCall('3ê³¼')">3ê³¼</button>
  </div>

  <audio id="alarmSound" src="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg" preload="auto"></audio>

  <!-- Firebase + ë™ê¸°í™” -->
  <script type="module">
    /***** Firebase SDK (CDN) *****/
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getDatabase, ref, set, update, onValue, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCDPfyuS-lXHkkmbHEkE2sqFBkBvb_zhVg",
      authDomain: "treatment-timer.firebaseapp.com",
      databaseURL: "https://treatment-timer-default-rtdb.asia-southeast1.firebasedatabase.app/",
      projectId: "treatment-timer",
      storageBucket: "treatment-timer.firebasestorage.app",
      messagingSenderId: "723002106763",
      appId: "1:723002106763:web:0b6aa89d5c42acc2f0458e",
      measurementId: "G-VV9B5R5EZL"
    };
    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);

    /***** ìƒìˆ˜/ìƒíƒœ *****/
    let DEFAULT_MINUTES = 10;
    const ROW_COUNT = 12;
    const COLS = ["í•«íŒ©", "ë¬¼ë¦¬ì¹˜ë£Œ", "ì¹¨ì¹˜ë£Œ", "ì¶”ë‚˜"];
    const sound = document.getElementById("alarmSound");
    const deptColors = {"":"", "ëŒ€í‘œ":"var(--dept-rep)", "ì–‘ë°©":"var(--dept-west)", "1ê³¼":"var(--dept-1)", "2ê³¼":"var(--dept-2)", "3ê³¼":"var(--dept-3)"};
    const blinkingDepts = new Set();
    const ROOM = "rooms/default";

    // ë¡œì»¬ ì¸í„°ë²Œ ê´€ë¦¬
    const intervals = {}; // key -> setInterval id

    /***** UI êµ¬ì¶• *****/
    function buildTable(){
      const tbody = document.getElementById("tableBody");
      for(let i=1;i<=ROW_COUNT;i++){
        const tr = document.createElement("tr"); tr.id = "row-"+i;

        // ë‹´ë‹¹
        const docTd = document.createElement("td");
        docTd.innerHTML = `
          <select class="doctor" onchange="changeDoctor(${i}, this.value)">
            <option value="">ì„ íƒ</option>
            <option value="ëŒ€í‘œ">ëŒ€í‘œ</option>
            <option value="ì–‘ë°©">ì–‘ë°©</option>
            <option value="1ê³¼">1ê³¼</option>
            <option value="2ê³¼">2ê³¼</option>
            <option value="3ê³¼">3ê³¼</option>
          </select>`;
        tr.appendChild(docTd);

        // í™˜ìëª…
        const nameTd = document.createElement("td");
        nameTd.textContent = i + "ë²ˆ í™˜ì";
        nameTd.contentEditable = true;
        nameTd.addEventListener("blur", () => {
          update(ref(db, `${ROOM}/rows/${i}`), { name: nameTd.textContent });
        });
        tr.appendChild(nameTd);

        // 4ì¹¸(í•«íŒ©/ë¬¼ë¦¬/ì¹¨/ì¶”ë‚˜)
        COLS.forEach((colName, j) => {
          const key = `r${i}_c${j}`;
          const td  = document.createElement("td");
          td.innerHTML = `
            <div class="status-box" id="box-${key}">
              <span class="pill pill-wait" id="status-${key}">ëŒ€ê¸°</span>
              <span class="time-text" id="time-${key}"></span>
              <div class="adjust-box">
                <button class="btn-adjust" onclick="adjustTime('${key}', 1)">ï¼‹</button>
                <button class="btn-adjust" onclick="adjustTime('${key}', -1)">ï¼</button>
              </div>
              <div>
                <button class="mini-btn mini-start" onclick="startTimer('${key}', '${colName}')">ì§„í–‰</button>
                <button class="mini-btn mini-stop"  onclick="stopTimer('${key}')">ì¤‘ì§€</button>
              </div>
            </div>`;
          tr.appendChild(td);
        });

        tbody.appendChild(tr);
      }
    }
    window.buildTable = buildTable;

    /***** ê¸°ë³¸ ì‹œê°„ *****/
    window.applyDefaultMinutes = () => {
      const v = parseInt(document.getElementById("defaultMinutes").value);
      if (!isNaN(v) && v > 0) { DEFAULT_MINUTES = v; alert(`ê¸°ë³¸ ì‹œê°„ ${v}ë¶„ìœ¼ë¡œ ì„¤ì •`); }
    };

    /***** ë‹´ë‹¹ ë³€ê²½ *****/
    window.changeDoctor = (rowIndex, dept) => {
      update(ref(db, `${ROOM}/rows/${rowIndex}`), { dept });
    };

    /***** íƒ€ì´ë¨¸ ì¡°ì‘ *****/
    // ë°ì´í„° ëª¨ë¸: timers/{key} = {colName, status, duration, endAt, remaining}
    window.startTimer = (key, colName) => {
      const baseMin = (colName === "ì¶”ë‚˜") ? 5 : DEFAULT_MINUTES;
      // DBì—ì„œ í˜„ì¬ ìƒíƒœë¥¼ ì½ì–´ê°€ë©° ê°±ì‹ 
      const tRef = ref(db, `${ROOM}/timers/${key}`);
      update(tRef, {
        colName,
        status: "ì§„í–‰",
        // ë‚¨ì€ ê°’ì´ ì—†ìœ¼ë©´ duration ìƒˆë¡œ ì„¸íŒ…
        duration: serverTimestamp(), // dummy(ì„œë²„ê°ì¸) â€” ì‹¤ì œ ë‚¨ì€ì‹œê°„ì€ endAtë¡œ ê³„ì‚°
      });
      // endAtì€ í´ë¼ì´ì–¸íŠ¸ ê¸°ì¤€ìœ¼ë¡œ ê°±ì‹ 
      // (ê°„ë‹¨/ì¦‰ì‹œì„± ëª©ì : ì´ˆ ë‹¨ìœ„ ì˜¤ì°¨ëŠ” í—ˆìš©)
      onValue(tRef, (snap) => {
        const v = snap.val() || {};
        // ê¸°ì¡´ remainingê°€ ìˆìœ¼ë©´ ê·¸ ê¸°ë°˜ìœ¼ë¡œ, ì—†ìœ¼ë©´ baseMinìœ¼ë¡œ
        const now = Date.now();
        const remainMs = (typeof v.remaining === "number" && v.remaining > 0)
          ? v.remaining * 1000
          : baseMin * 60 * 1000;
        update(tRef, { endAt: now + remainMs, status: "ì§„í–‰" });
      }, { onlyOnce: true });
    };

    window.stopTimer = (key) => {
      const tRef = ref(db, `${ROOM}/timers/${key}`);
      // stop ì‹œì  ë‚¨ì€ ì‹œê°„ ê³„ì‚°í•´ì„œ DB ì €ì¥(ì¬ê°œ ëŒ€ë¹„)
      onValue(tRef, (snap) => {
        const v = snap.val() || {};
        let remaining = 0;
        if (v.endAt) remaining = Math.max(0, Math.floor((v.endAt - Date.now())/1000));
        update(tRef, { status: "ëŒ€ê¸°", endAt: null, remaining });
      }, { onlyOnce: true });
    };

    window.adjustTime = (key, diffMin) => {
      const tRef = ref(db, `${ROOM}/timers/${key}`);
      onValue(tRef, (snap) => {
        const v = snap.val() || {};
        // ì‹¤í–‰ ì¤‘ì´ë©´ endAt ì´ë™, ëŒ€ê¸° ì¤‘ì´ë©´ remaining/durationë§Œ ì¡°ì •
        const diffMs = diffMin * 60 * 1000;
        if (v.status === "ì§„í–‰" && v.endAt) {
          update(tRef, { endAt: v.endAt + diffMs });
        } else {
          const base = (v.colName === "ì¶”ë‚˜") ? 5 : DEFAULT_MINUTES;
          const cur = (typeof v.remaining === "number" && v.remaining > 0) ? v.remaining : base*60;
          const nxt = Math.max(60, cur + diffMin*60);
          update(tRef, { remaining: nxt });
        }
      }, { onlyOnce: true });
    };

    /***** ê°„í˜¸ì‚¬ í˜¸ì¶œ *****/
    window.toggleCall = (dept) => {
      const cRef = ref(db, `${ROOM}/nurseCalls/${dept}`);
      onValue(cRef, (snap) => {
        const on = !(snap.val() && snap.val().on);
        set(cRef, { on });
      }, { onlyOnce: true });
    };

    /***** êµ¬ë…(ì‹¤ì‹œê°„ ë°˜ì˜) *****/
    // 1) í–‰/ë‹´ë‹¹/ì´ë¦„
    onValue(ref(db, `${ROOM}/rows`), (snap) => {
      const rows = snap.val() || {};
      for (let i=1;i<=ROW_COUNT;i++){
        const r = rows[i] || {};
        const tr = document.getElementById("row-"+i);
        if (!tr) continue;

        const sel = tr.querySelector("select.doctor");
        if (sel && sel.value !== (r.dept||"")) sel.value = r.dept||"";
        tr.style.background = deptColors[r.dept||""] || "";

        const nameTd = tr.children[1];
        if (r.name && nameTd.textContent !== r.name) nameTd.textContent = r.name;

        // í˜¸ì¶œ ê¹œë¹¡ì„ ë°˜ì˜
        if (r.dept && blinkingDepts.has(r.dept)) tr.classList.add("blink-row");
        else tr.classList.remove("blink-row");
      }
    });

    // 2) íƒ€ì´ë¨¸(ëª¨ë“  ì…€)
    onValue(ref(db, `${ROOM}/timers`), (snap) => {
      const timers = snap.val() || {};
      Object.entries(timers).forEach(([key, v]) => {
        const st = document.getElementById("status-"+key);
        const tt = document.getElementById("time-"+key);
        if (!st || !tt) return;

        // pill ìƒíƒœ
        const status = v.status || "ëŒ€ê¸°";
        st.textContent = status;
        st.className = "pill " + (status==="ì§„í–‰" ? "pill-run" : status==="ì™„ë£Œ" ? "pill-done" : "pill-wait");

        // ì¸í„°ë²Œ ì •ë¦¬
        if (intervals[key]) { clearInterval(intervals[key]); intervals[key]=null; }

        if (status === "ì§„í–‰" && v.endAt){
          const tick = () => {
            const remain = Math.max(0, Math.floor((v.endAt - Date.now())/1000));
            tt.textContent = fmt(remain);
            if (remain <= 0){
              clearInterval(intervals[key]); intervals[key]=null;
              st.textContent = "ì™„ë£Œ"; st.className = "pill pill-done";
              tt.textContent = "";
              try{ sound.play(); }catch(e){}
              update(ref(db, `${ROOM}/timers/${key}`), { status: "ì™„ë£Œ", endAt: null, remaining: 0 });
            }
          };
          tick();
          intervals[key] = setInterval(tick, 1000);
        } else {
          // ëŒ€ê¸°/ì™„ë£Œ ìƒíƒœ
          const base = (v.colName === "ì¶”ë‚˜") ? 5 : DEFAULT_MINUTES;
          const remain = (typeof v.remaining === "number" && v.remaining>0) ? v.remaining : (status==="ì™„ë£Œ"?0:base*60);
          tt.textContent = remain>0 ? fmt(remain) : "";
        }
      });
    });

    // 3) ê°„í˜¸ì‚¬ í˜¸ì¶œ
    onValue(ref(db, `${ROOM}/nurseCalls`), (snap) => {
      const c = snap.val() || {};
      ["ëŒ€í‘œ","ì–‘ë°©","1ê³¼","2ê³¼","3ê³¼"].forEach(d=>{
        const b = document.getElementById("call-"+d);
        const on = !!(c[d] && c[d].on);
        b.classList.toggle("on", on);
        b.classList.toggle("blink-btn", on);
        if (on) blinkingDepts.add(d); else blinkingDepts.delete(d);
      });

      // í˜„ì¬ ì„ íƒëœ ë‹´ë‹¹ ê¸°ì¤€ìœ¼ë¡œ í–‰ ê¹œë¹¡ì„ í† ê¸€
      for (let i=1;i<=ROW_COUNT;i++){
        const row = document.getElementById("row-"+i);
        const sel = row?.querySelector("select.doctor");
        const dept = sel?.value || "";
        if (dept && blinkingDepts.has(dept)) row.classList.add("blink-row");
        else row.classList.remove("blink-row");
      }
    });

    /***** ìœ í‹¸ *****/
    function fmt(sec){ const m=Math.floor(sec/60), s=sec%60; return `${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`; }

    // ì´ˆê¸° ë Œë”
    buildTable();
  </script>
</body>
</html>
