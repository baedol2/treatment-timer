<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ì¹˜ë£Œì‹¤ íƒ€ì´ë¨¸ ë³´ë“œ v3.12 (ë‹´ë‹¹ ë¯¸ì„ íƒ ì‹œ ì‹œê°„Â·ë²„íŠ¼ ìˆ¨ê¹€)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --purple:#4b0082;
      --yellow:#ffe08a;
      /* ê³¼ë³„ ë°°ê²½ìƒ‰ */
      --dept-west:#d3d3d3;  /* ì–‘ë°©: íšŒìƒ‰ */
      --dept-1:#87ceeb;     /* 1ê³¼: í•˜ëŠ˜ìƒ‰ */
      --dept-2:#90ee90;     /* 2ê³¼: ì—°ë‘ìƒ‰ */
      --dept-3:#d2b48c;     /* 3ê³¼: ê°ˆìƒ‰(íƒ„ ìƒ‰) */
      --dept-4:#ffc0cb;     /* 4ê³¼: í•‘í¬ìƒ‰ */
    }

    /* ===== ë ˆì´ì•„ì›ƒ ===== */
    body{
      font-family:"Noto Sans KR",sans-serif;
      background:#f5f7fb;
      margin:0;
      padding:14px;
    }

    h2{margin:0 0 8px; display:inline-block;}

    /* ìƒë‹¨ ì»¨íŠ¸ë¡¤ ë°” */
    .topbar{
      display:flex; flex-wrap:wrap; gap:12px; align-items:center; margin-bottom:12px;
    }
    .grow{ flex:1 1 auto; }

    .sound-btn{
      border:none; border-radius:999px; padding:14px 20px; font-size:18px; cursor:pointer; font-weight:700;
      background:#f1f3f5; box-shadow:0 2px 6px rgba(0,0,0,0.05);
    }
    .sound-btn.on{ outline:3px solid #4caf50; } 
    .sound-btn.off{ outline:3px solid #999; background:#f8f8f8; color:#666; }
    .sound-btn.chan.on{ outline:3px solid #4caf50; }

    .danger-btn{
      border:none; border-radius:999px; padding:14px 20px; font-size:18px; cursor:pointer; font-weight:700;
      background:#ffecec; color:#9b1c1c; box-shadow:0 2px 6px rgba(0,0,0,0.05); border:1px solid #f5b3b3;
    }

    .floor-tab{ border:none; border-radius:999px; padding:12px 18px; font-size:18px; cursor:pointer; background:#fff; }
    .floor-tab.on{ outline:3px solid #6c5ce7; background:#eee; }

    .role-chip{ border:none; border-radius:999px; padding:12px 18px; font-size:18px; cursor:pointer; background:#fff; }
    .role-chip.on{ outline:3px solid #00c853; background:#eaffea; }

    /* ìš”ì¼ ì„ íƒ ë²„íŠ¼ */
    .day-chip{ border:none; border-radius:999px; padding:12px 18px; font-size:18px; cursor:pointer; background:#fff; }
    .day-chip.on{ outline:3px solid #ff9800; background:#fff3e0; }

    table{ width:100%; border-collapse:collapse; background:#fff; box-shadow:0 2px 8px rgba(0,0,0,0.03); }
    /* â—† í—¤ë” ë°°ê²½ìƒ‰ ë‚¨ìƒ‰ + ê¸€ì”¨ í¬ê²Œ */
    thead{ background:#002f6c; color:#fff; }
    th,td{ border:1px solid #ececec; padding:12px 10px; text-align:center; font-size:18px; }
    thead th{
      font-size:30px;
      font-weight:900;
    }

    /* â–¶ í­ ì¬ì¡°ì •: ì´ë¦„ ì¹¸ í™•ëŒ€, ì¹˜ë£Œ ì¹¸ ì¶•ì†Œ */
    th:nth-child(1){ width:170px; }
    th:nth-child(2){ width:420px; text-align:center; }  /* ì´ë¦„ ì¹¸ ë„“í˜ */
    td:nth-child(2){ text-align:left; }
    th:nth-child(3), th:nth-child(4), th:nth-child(5){ width:210px; } /* ì¹˜ë£Œ ì¹¸ ì¤„ì„ */
    th:nth-child(6){ width:240px; } /* ì¶”ë‚˜ ì¹¸ ì—¬ìœ  */

    /* ì´ë¦„ ê¸€ì í¬ê²Œ (2ë°° ì •ë„) */
    .name-cell{
      font-size:60px;
      font-weight:800; line-height:1.2; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }

    /* ===== í° ì…€ ë ˆì´ì•„ì›ƒ(ê³µí†µ) ===== */
    .status-box{
      display:grid; grid-template-columns: 1fr auto; align-items:center; gap:16px;
      min-height:140px; padding:14px 14px; border-radius:16px; background:#ffffff;
    }
    .left-col{ display:flex; align-items:center; gap:14px; }
    .time-text{
      font-weight:900; color:#D9534F;
      font-size:clamp(40px, 5.0vw, 56px);
      min-width:96px; text-align:left; letter-spacing:1px;
    }
    .right-col{
      display:grid; grid-auto-flow:row; grid-template-columns: repeat(3, minmax(120px, 1fr));
      gap:12px; justify-content:end; align-content:center;
    }

    .pill{ display:inline-block; padding:10px 16px; border-radius:999px; font-size:18px; font-weight:900; }
    .pill-wait{ background:#fff; border:3px solid #ddd; color:#444; }
    .pill-run{ background:var(--yellow); color:#222; }
    .pill-done{ background:#ffb6b6; color:#681212; }

    /* âœ… ì§„í–‰/ì¤‘ì§€ ë²„íŠ¼ í¬ê²Œ (ì¶”ë‚˜ ìˆ˜ì¤€) */
    .mini-btn{
      border:none; border-radius:20px;
      padding:22px 28px;
      font-size:30px;
      font-weight:900;
      cursor:pointer;
      width:100%;
      height:86px;
    }
    .mini-start{ background:#0d6efd; color:#fff; }
    .mini-stop{  background:#ffc107; color:#222; }

    .adjust-box{ display:flex; flex-direction:column; gap:10px; justify-content:stretch; align-items:stretch; }
    .btn-adjust{ background:#fff; border:3px solid #bdbdbd; border-radius:16px; width:100%; height:56px; font-size:26px; cursor:pointer; font-weight:900; }

    /* âœ… ì™„ë£Œ ì‹œ ë¶‰ì€ìƒ‰ ê³„ì—´ë¡œ ê¹œë¹¡ì„ */
    @keyframes cellBlink{
      0%{
        transform:scale(1);
        box-shadow:0 0 0 0 rgba(255,255,255,0.0);
        filter:brightness(1);
      }
      50%{
        transform:scale(1.03);
        box-shadow:0 0 0 14px rgba(255,255,255,0.7);
        filter:brightness(1.15);
      }
      100%{
        transform:scale(1);
        box-shadow:0 0 0 0 rgba(255,255,255,0.0);
        filter:brightness(1);
      }
    }
    .cell-blink{
      animation:cellBlink 1s ease-in-out infinite;
    }

    /* ===== í˜¸ì¶œ UI: ì œëª© ì•„ë˜ í•œ ì¤„ (í™•ëŒ€ + ìŠ¤í‹°í‚¤) ===== */
    .call-sticky{
      position: sticky;
      top: 0;
      z-index: 1000;
      padding: 6px 0;
      background: rgba(245,247,251,0.96);
      backdrop-filter: blur(3px);
      border-bottom: 1px solid #e8ecf3;
    }
    .call-inline{
      width:100%;
      display:flex;
      flex-wrap:wrap;
      gap:40px 40px;            /* ê·¸ë£¹ ê°„ ê°„ê²© */
      align-items:center;
      justify-content:center;
    }
    .call-group{
      display:flex; align-items:center; gap:48px; padding:18px 22px; background:#fff; border-radius:14px;
      box-shadow:0 2px 6px rgba(0,0,0,0.05);
      font-weight:900;
    }
    .call-label{ margin-right:2px; color:#444; font-size:24px; font-weight:900; }
    .btn-call{
      border:none; border-radius:999px;
      padding:20px 30px;
      font-size:30px;
      cursor:pointer; background:#f1f3f5; font-weight:900;
      box-shadow:0 3px 8px rgba(0,0,0,0.15);
      line-height:1;
      min-width:90px;
      transition:transform 0.2s ease, box-shadow 0.2s ease;
    }
    .btn-call.on{ outline:3px solid #ff4d4f; background:#ffe6e6; }
    .btn-call[disabled]{ opacity:.45; cursor:not-allowed; }

    /* ë¡œê³  ê°€ìš´ë° */
    .logo-wrap{
      display:flex;
      align-items:center;
      justify-content:center;
      padding:8px 16px;
    }
    .logo-img{
      height:120px;
      object-fit:contain;
    }

    /* â–¶ í˜¸ì¶œ ë²„íŠ¼ ê¹œë¹¡ì„ ì•¡ì…˜ í¬ê²Œ */
    @keyframes blinkBtn{
      0%{
        background:#ffe6e6;
        transform:scale(1);
        box-shadow:0 0 0 0 rgba(255,77,77,0.7);
      }
      50%{
        background:#ffb3b3;
        transform:scale(1.15);
        box-shadow:0 0 0 16px rgba(255,77,77,0);
      }
      100%{
        background:#ffe6e6;
        transform:scale(1);
        box-shadow:0 0 0 0 rgba(255,77,77,0.7);
      }
    }
    .blink-btn{ animation:blinkBtn .7s ease-in-out infinite; }

    .listen-group{ display:flex;gap:8px;align-items:center; flex-wrap:wrap; }

    tbody > tr > td { padding:8px; }

    @media (max-width:1100px){
      .call-inline{ gap:24px 24px; }
      .btn-call{ padding:16px 22px; font-size:24px; min-width:70px; }
      .mini-btn{ height:76px; font-size:28px; padding:20px 24px; }
      .btn-adjust{ height:52px; font-size:24px; }
      .logo-img{ height:48px; }
    }

    /* âœ… í˜¸ì¶œ UI ì¸µë³„ ìƒ‰ìƒ */
    .call-1F .btn-call{ background:#ffe5e5; color:#b30000; border:3px solid #ff4d4d; }
    .call-2F .btn-call{ background:#e5f0ff; color:#0048b3; border:3px solid #4d8cff; }
    .btn-call.on{ background:#ffcccc; border-color:#ff0000; }
    .call-2F .btn-call.on{ background:#cce0ff; border-color:#0058ff; }
    .call-sticky { padding:14px 0; }

    /* ===== ì¹˜ë£Œ ì¹¸(í•«íŒ©/ë¬¼ë¦¬/ì¹¨) ì¶•ì†Œ ì „ìš© (ì´ë¦„ì¹¸ í™•ë³´) ===== */
    .therapy-cell .status-box{ min-height:140px; padding:12px; }
    .therapy-cell .time-text{
      font-size:clamp(36px, 4.2vw, 50px);
      min-width:90px;
    }

    /* ===== ì¶”ë‚˜(O/X) í¬ê²Œ + ì´ˆê¸°í™” ë²„íŠ¼ ===== */
    .chuna-box{
      display:flex; align-items:center; justify-content:space-between;
      min-height:140px; padding:16px; border-radius:16px; background:#fff;
      gap:16px;
    }
    .ox-group{ display:flex; gap:16px; align-items:center; }
    .ox-btn{
      border:3px solid #444; background:#fff; border-radius:16px;
      padding:18px 26px; font-size:32px; font-weight:900; cursor:pointer;
      min-width:90px;
    }
    .ox-btn.ox-on{ background:#0d6efd; color:#fff; border-color:#0d6efd; }

    .reset-btn{
      border:3px solid #777; background:#f1f3f5; border-radius:16px;
      padding:16px 22px; font-size:22px; font-weight:900; cursor:pointer;
      min-width:110px;
    }
    .reset-btn:active{ transform:translateY(1px); }

    /* âœ… ë‹´ë‹¹(ì£¼ì¹˜ì˜) ë¯¸ì„ íƒ í–‰: ì‹œê°„í‘œì‹œ + ë²„íŠ¼ ì—´ ìˆ¨ê¹€ */
    tr.no-doctor .time-text{ display:none; }
    tr.no-doctor .right-col{ display:none; }

    /* âœ… ì£¼ë§ ëª¨ë“œ: ë¬¼ë¦¬ì¹˜ë£Œ(4ë²ˆì§¸ ì—´) ìˆ¨ê¹€ */
    body.weekend-mode #timerTable th:nth-child(4),
    body.weekend-mode #timerTable td:nth-child(4){
      display:none;
    }
  </style>
</head>
<body>
  <!-- ì œëª© -->
  <h2>ğŸ¥ ì¹˜ë£Œì‹¤ íƒ€ì´ë¨¸íŒ</h2>

  <!-- ì œëª© ì•„ë˜: ìŠ¤í¬ë¡¤ ê³ ì • í˜¸ì¶œ UI -->
  <div class="call-sticky">
    <div class="call-inline">
      <!-- âœ… 1ì¸µ ê·¸ë£¹ -->
      <div class="call-group call-1F">
        <span class="call-label">1ì¸µ:</span>
        <button class="btn-call" id="call-1F-1ê³¼" title="1ì¸µ-1ê³¼" onclick="toggleCall('1F','1ê³¼')">1</button>
        <button class="btn-call" id="call-1F-2ê³¼" title="1ì¸µ-2ê³¼" onclick="toggleCall('1F','2ê³¼')">2</button>
        <button class="btn-call" id="call-1F-3ê³¼" title="1ì¸µ-3ê³¼" onclick="toggleCall('1F','3ê³¼')">3</button>
        <button class="btn-call" id="call-1F-4ê³¼" title="1ì¸µ-4ê³¼" onclick="toggleCall('1F','4ê³¼')">4</button>
        <button class="btn-call" id="call-1F-ì–‘ë°©" title="1ì¸µ-ì–‘ë°©" onclick="toggleCall('1F','ì–‘ë°©')">ì–‘</button>
      </div>

      <!-- ê°€ìš´ë° ë³‘ì› ë¡œê³  -->
      <div class="logo-wrap">
        <img src="logo_seongmo.png" alt="ì„±ëª¨ì‚¬ë‘í•œë°©ë³‘ì› ë¡œê³ " class="logo-img">
      </div>

      <!-- âœ… 2ì¸µ ê·¸ë£¹ -->
      <div class="call-group call-2F">
        <span class="call-label">2ì¸µ:</span>
        <button class="btn-call" id="call-2F-1ê³¼" title="2ì¸µ-1ê³¼" onclick="toggleCall('2F','1ê³¼')">1</button>
        <button class="btn-call" id="call-2F-2ê³¼" title="2ì¸µ-2ê³¼" onclick="toggleCall('2F','2ê³¼')">2</button>
        <button class="btn-call" id="call-2F-3ê³¼" title="2ì¸µ-3ê³¼" onclick="toggleCall('2F','3ê³¼')">3</button>
        <button class="btn-call" id="call-2F-4ê³¼" title="2ì¸µ-4ê³¼" onclick="toggleCall('2F','4ê³¼')">4</button>
        <button class="btn-call" id="call-2F-ì–‘ë°©" title="2ì¸µ-ì–‘ë°©" onclick="toggleCall('2F','ì–‘ë°©')">ì–‘</button>
      </div>
    </div>
  </div>

  <!-- ìƒë‹¨ ì»¨íŠ¸ë¡¤(ìš”ì¼/ì¸µ/ì—­í• /ì‚¬ìš´ë“œ/ì±„ë„/ì„¤ì •) -->
  <div class="topbar">
    <div class="grow"></div>

    <!-- ìš”ì¼ ì„ íƒ: í‰ì¼ / ì£¼ë§ -->
    <div style="display:flex;gap:8px;align-items:center;">
      <span style="font-weight:900;">ìš”ì¼:</span>
      <button class="day-chip" id="day-weekday" onclick="setDayType('weekday')">í‰ì¼</button>
      <button class="day-chip" id="day-weekend" onclick="setDayType('weekend')">ì£¼ë§</button>
    </div>

    <div style="display:flex;gap:8px;align-items:center;">
      <button class="floor-tab" id="tab-1F" onclick="switchFloor('1F')">1ì¸µ</button>
      <button class="floor-tab" id="tab-2F" onclick="switchFloor('2F')">2ì¸µ</button>
    </div>

    <div style="display:flex;gap:8px;align-items:center;">
      <span style="font-weight:900;">ì—­í• :</span>
      <button class="role-chip" id="role-doctor" onclick="setRole('doctor')">ì˜ì‚¬</button>
      <button class="role-chip" id="role-nurse"  onclick="setRole('nurse')">ê°„í˜¸ì‚¬</button>
    </div>

    <button id="btnCompleteSound" class="sound-btn on" onclick="toggleCompleteSound()">ì™„ë£ŒìŒ: ON</button>
    <button id="btnNurseSound"    class="sound-btn on" onclick="toggleNurseSound()">í˜¸ì¶œìŒ: ON</button>

    <div class="listen-group">
      <span style="font-weight:900;">ìˆ˜ì‹  ì±„ë„:</span>
      <button class="sound-btn chan" data-dept="1ê³¼" onclick="toggleListen('1ê³¼')">1ê³¼</button>
      <button class="sound-btn chan" data-dept="2ê³¼" onclick="toggleListen('2ê³¼')">2ê³¼</button>
      <button class="sound-btn chan" data-dept="3ê³¼" onclick="toggleListen('3ê³¼')">3ê³¼</button>
      <button class="sound-btn chan" data-dept="4ê³¼" onclick="toggleListen('4ê³¼')">4ê³¼</button>
      <button class="sound-btn chan" data-dept="ì–‘ë°©" onclick="toggleListen('ì–‘ë°©')">ì–‘ë°©</button>
    </div>

    <button class="danger-btn" onclick="resetSettings()">âš™ï¸ ì„¤ì • ì´ˆê¸°í™”</button>
  </div>

  <table id="timerTable">
    <thead>
      <tr>
        <th>ë‹´ë‹¹<br><small>ì£¼ì¹˜ì˜</small></th>
        <th>í™˜ìì´ë¦„</th>
        <th>í•«íŒ©</th>
        <th>ë¬¼ë¦¬ì¹˜ë£Œ</th>
        <th>ì¹¨ì¹˜ë£Œ</th>
        <th>ì¶”ë‚˜(O/X)</th>
      </tr>
    </thead>
    <tbody id="tableBody"></tbody>
  </table>

  <!-- (êµ¬) ê¸°ë³¸ ë¹„í”„ìŒ: ì˜ˆë¹„ìš©ìœ¼ë¡œë§Œ ë‚¨ê¹€ -->
  <audio id="beep" preload="auto" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg"></audio>

  <!-- ìƒˆ ì™„ë£ŒìŒ: 2ë²ˆ ìš¸ë¦¼ -->
  <audio id="soundComplete" preload="auto" src="ì™„ë£ŒìŒ.mp3"></audio>

  <!-- ìƒˆ í˜¸ì¶œìŒ: 1ë²ˆ ìš¸ë¦¼ -->
  <audio id="soundCall" preload="auto" src="í˜¸ì¶œìŒ.mp3"></audio>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getDatabase, ref, set, update, onValue, off, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCDPfyuS-lXHkkmbHEkE2sqFBkBvb_zhVg",
      authDomain: "treatment-timer.firebaseapp.com",
      databaseURL: "https://treatment-timer-default-rtdb.asia-southeast1.firebasedatabase.app/",
      projectId: "treatment-timer",
      storageBucket: "treatment-timer.firebasestorage.app",
      messagingSenderId: "723002106763",
      appId: "1:723002106763:web:0b6aa89d5c42acc2f0458e",
      measurementId: "G-VV9B5R5EZL"
    };
    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);

    const DEPTS  = ["1ê³¼","2ê³¼","3ê³¼","4ê³¼","ì–‘ë°©"];
    const FLOORS = ["1F","2F"];

    let currentFloor = new URLSearchParams(location.search).get('floor') || localStorage.getItem('currentFloor') || '1F';
    const ROLE_KEY = 'ttb_role';
    const roleParam = new URLSearchParams(location.search).get('role');
    if (roleParam === 'doctor' || roleParam === 'nurse') localStorage.setItem(ROLE_KEY, roleParam);
    let role = (localStorage.getItem(ROLE_KEY) || 'doctor'); // doctor | nurse

    /* í‰ì¼/ì£¼ë§ ëª¨ë“œ */
    const DAY_KEY = 'ttb_dayType';
    let dayType = localStorage.getItem(DAY_KEY) || 'weekday';

    /* ê¸°ë³¸ ì‹œê°„: UI ì œê±° â†’ ì €ì¥ëœ ê°’ì´ ìˆìœ¼ë©´ ì‚¬ìš©, ê¸°ë³¸ì€ 10ë¶„ */
    let DEFAULT_MINUTES = parseInt(localStorage.getItem('defaultMinutes') || '10', 10);
    const ROW_COUNT = 12;
    const COLS = ["í•«íŒ©","ë¬¼ë¦¬ì¹˜ë£Œ","ì¹¨ì¹˜ë£Œ"];

    const deptColors = {
      "": "",
      "ì–‘ë°©":"var(--dept-west)",
      "1ê³¼":"var(--dept-1)",
      "2ê³¼":"var(--dept-2)",
      "3ê³¼":"var(--dept-3)",
      "4ê³¼":"var(--dept-4)"
    };

    const intervals = {};
    const lastCallState2 = { "1F": Object.fromEntries(DEPTS.map(d=>[d,false])), "2F": Object.fromEntries(DEPTS.map(d=>[d,false])) };

    /* âœ… ì™„ë£Œ ì…€ ê¹œë¹¡ì„ ìƒíƒœ ê´€ë¦¬: ì™„ë£Œ ì‹œ ë¶‰ì€ìƒ‰ ê³„ì—´ë¡œ í†µì¼ */
    function setCellBlink(key, on){
      const box = document.getElementById("box-"+key);
      if (!box) return;
      if (on){
        box.style.background = "#ffb3b3";
        box.classList.add("cell-blink");
      } else {
        box.classList.remove("cell-blink");
        box.style.background = "#ffffff";
      }
    }

    /* ìˆ˜ì‹  ì±„ë„/ì‚¬ìš´ë“œ ì„¤ì • */
    const beep = document.getElementById('beep');
    let completeSoundOn = JSON.parse(localStorage.getItem('completeSoundOn') || 'true');
    let nurseSoundOn    = JSON.parse(localStorage.getItem('nurseSoundOn')    || 'true');
    let listenChannels  = JSON.parse(localStorage.getItem('listenChannels')  || '{}');
    listenChannels = Object.assign(Object.fromEntries(DEPTS.map(d=>[d,true])), listenChannels);

    /* âœ… ìƒˆ ì‚¬ìš´ë“œ ì¬ìƒ í•¨ìˆ˜ */
    function playCompleteSound(){
      if (!completeSoundOn) return;
      try{
        const snd = document.getElementById('soundComplete');
        if (!snd) return;
    
        // í˜¹ì‹œ ë‚¨ì•„ìˆëŠ” ended ë¦¬ìŠ¤ë„ˆê°€ ìˆë‹¤ë©´ ì œê±°í•˜ëŠ” ì•ˆì „ ì¥ì¹˜ (ì„ íƒì‚¬í•­)
        const clone = snd.cloneNode(true);
        snd.parentNode.replaceChild(clone, snd);
        const audio = document.getElementById('soundComplete');
    
        // ì²« ë²ˆì§¸ ì¬ìƒ
        audio.currentTime = 0;
        audio.play();
    
        // ì²« ë²ˆì§¸ ì¬ìƒì´ ëë‚œ í›„ í•œ ë²ˆ ë” ì¬ìƒ (ê²¹ì¹˜ì§€ ì•Šë„ë¡ once ì˜µì…˜)
        audio.addEventListener('ended', () => {
          audio.currentTime = 0;
          audio.play();
        }, { once: true });
    
      }catch(e){}
    }

    /* (êµ¬) ë¹„í”„ ê´€ë ¨ í•¨ìˆ˜ëŠ” ë‚¨ê²¨ë‘ë˜, ë” ì´ìƒ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ */
    function save(k,v){ localStorage.setItem(k, JSON.stringify(v)); }
    function applyListenUI(){ DEPTS.forEach(d => { document.querySelector(`.sound-btn.chan[data-dept="${d}"]`)?.classList.toggle('on', !!listenChannels[d]); }); }
    function applySoundButtons(){
      const b1 = document.getElementById('btnCompleteSound');
      const b2 = document.getElementById('btnNurseSound');
      if (b1) { b1.classList.toggle('on',  completeSoundOn); b1.classList.toggle('off', !completeSoundOn); b1.textContent = `ì™„ë£ŒìŒ: ${completeSoundOn?'ON':'OFF'}`; }
      if (b2) { b2.classList.toggle('on',  nurseSoundOn);    b2.classList.toggle('off', !nurseSoundOn);    b2.textContent = `í˜¸ì¶œìŒ: ${nurseSoundOn?'ON':'OFF'}`; }
    }
    function applyRoleUI(){
      document.getElementById('role-doctor')?.classList.toggle('on', role==='doctor');
      document.getElementById('role-nurse')?.classList.toggle('on',  role==='nurse');
      FLOORS.forEach(f=>{
        DEPTS.forEach(d=>{
          const btn = document.getElementById(`call-${f}-${d}`);
          if (!btn) return;
          if (role==='nurse'){
            const enable = (f === currentFloor);
            btn.disabled = !enable;
            btn.title = enable ? "" : "ê°„í˜¸ì‚¬ í™”ë©´ì—ì„œëŠ” ìì‹ ì˜ ì¸µë§Œ ì¡°ì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.";
          }else{
            btn.disabled = false; btn.title = "";
          }
        });
      });
    }
    function applyFloorTabs(){ FLOORS.forEach(f => document.getElementById('tab-'+f)?.classList.toggle('on', f===currentFloor)); }

    /* í‰ì¼/ì£¼ë§ UI ë° ëª¨ë“œ ì ìš© */
    function applyDayUI(){
      const weekdayBtn = document.getElementById('day-weekday');
      const weekendBtn = document.getElementById('day-weekend');
      if (weekdayBtn) weekdayBtn.classList.toggle('on', dayType === 'weekday');
      if (weekendBtn) weekendBtn.classList.toggle('on', dayType === 'weekend');

      document.body.classList.toggle('weekend-mode', dayType === 'weekend');
    }

    applyListenUI();
    applySoundButtons();
    applyRoleUI();
    applyFloorTabs();
    applyDayUI();

    window.toggleCompleteSound = () => { completeSoundOn = !completeSoundOn; save('completeSoundOn',completeSoundOn); applySoundButtons(); };
    window.toggleNurseSound    = () => { nurseSoundOn    = !nurseSoundOn;    save('nurseSoundOn',nurseSoundOn);    applySoundButtons(); };
    window.toggleListen = (dept) => { listenChannels[dept] = !listenChannels[dept]; save('listenChannels',listenChannels); applyListenUI(); };
    window.resetSettings = () => { if (confirm("ì„¤ì •ì„ ëª¨ë‘ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) { localStorage.clear(); alert("ì„¤ì •ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤."); location.reload(); } };

    window.setRole = (r) => { if (r!=='doctor' && r!=='nurse') return; role=r; localStorage.setItem(ROLE_KEY, r); applyRoleUI(); reattachNurseListeners(); };

    /* í‰ì¼/ì£¼ë§ ëª¨ë“œ ë³€ê²½ */
    window.setDayType = (mode) => {
      if (mode !== 'weekday' && mode !== 'weekend') return;
      dayType = mode;
      localStorage.setItem(DAY_KEY, mode);
      applyDayUI();
    };

    window.switchFloor = (f) => {
      if (!FLOORS.includes(f)) return;
      currentFloor = f; localStorage.setItem('currentFloor', f); applyFloorTabs();
      teardownFloorListeners(); attachFloorListeners(); reattachNurseListeners(); applyRoleUI();
    };

    function roomPath(){ return `rooms/${currentFloor}`; }

    // ì–‘ë°© ì„ íƒ ì‹œ: ì¹¨ì¹˜ë£Œ ì…€ í­ì€ ìœ ì§€í•˜ê³  ì•ˆìª½ ë°•ìŠ¤ë§Œ ìˆ¨ê¹€
    function updateYangbangCell(rowIndex, dept){
      const tr = document.getElementById("row-"+rowIndex);
      if (!tr) return;
      const chimTd = tr.querySelector('td.therapy-cell[data-col="ì¹¨ì¹˜ë£Œ"]');
      if (chimTd){
        const box = chimTd.querySelector('.status-box');
        if (box){
          box.style.visibility = (dept === "ì–‘ë°©") ? "hidden" : "visible";
        }
      }
    }

    window.changeDoctor = (rowIndex, dept) => {
      update(ref(db, `${roomPath()}/rows/${rowIndex}`), { dept });
      const tr = document.getElementById("row-"+rowIndex);
      if (tr) tr.style.background = deptColors[dept] || "";
      updateYangbangCell(rowIndex, dept);

      // ì–‘ë°© ì„ íƒ ì‹œ ì¹¨ì¹˜ë£Œ íƒ€ì´ë¨¸ë„ ì´ˆê¸°í™”
      if (dept === "ì–‘ë°©"){
        const key = `r${rowIndex}_c2`; // ì¹¨ì¹˜ë£Œ
        update(ref(db, `${roomPath()}/timers/${key}`), {
          status:"ëŒ€ê¸°", endAt:null, remaining:0, ack:false
        });
        setCellBlink(key,false);
      }
    };

    /* ===== íƒ€ì´ë¨¸ ì¡°ì‘ ===== */
    window.startTimer = (key, colName) => {
      const baseMin = DEFAULT_MINUTES;
      const tRef = ref(db, `${roomPath()}/timers/${key}`);
      update(tRef, { colName, status: "ì§„í–‰" });
      onValue(tRef, (snap) => {
        const v = snap.val() || {};
        const now = Date.now();
        const remainMs = (typeof v.remaining === "number" && v.remaining > 0) ? v.remaining * 1000 : baseMin * 60 * 1000;
        update(tRef, { endAt: now + remainMs, status: "ì§„í–‰", ack:false });
      }, { onlyOnce: true });
    };
    window.stopTimer = (key) => {
      const tRef = ref(db, `${roomPath()}/timers/${key}`);
      update(tRef, { status: "ëŒ€ê¸°", endAt: null, remaining: 0, ack:false });
      setCellBlink(key,false);
    };
    window.adjustTime = (key, diffSec) => {
      const tRef = ref(db, `${roomPath()}/timers/${key}`);
      onValue(tRef, (snap) => {
        const v = snap.val() || {};
        const diffMs = diffSec * 1000;
        if (v.status === "ì§„í–‰" && v.endAt) {
          update(tRef, { endAt: v.endAt + diffMs });
        } else {
          const base = DEFAULT_MINUTES;
          const curSec = (typeof v.remaining === "number" && v.remaining > 0) ? v.remaining : base * 60;
          const nxtSec = Math.max(30, curSec + diffSec);
          update(tRef, { remaining: nxtSec });
        }
      }, { onlyOnce: true });
    };

    /* ===== ë°•ìŠ¤ í´ë¦­: ì™„ë£Œ ì‹œ 1ë²ˆ í„°ì¹˜=ê¹œë¹¡ì´ê¸°ë§Œ í•´ì œ, 2ë²ˆ í„°ì¹˜=ê¸°ë³¸ì‹œê°„ ë¦¬ì…‹ ===== */
    window.onBoxClick = (key) => {
      const tRef = ref(db, `${roomPath()}/timers/${key}`);
      onValue(tRef, (snap) => {
        const v = snap.val() || {};
        const status = v.status || "ëŒ€ê¸°";
        const ack    = !!v.ack;

        if (status === "ì™„ë£Œ") {
          if (!ack) {
            update(tRef, { ack: true });
            setCellBlink(key,false);   // ì²« í´ë¦­: ê¹œë¹¡ì„ í•´ì œ + í°ìƒ‰ ë³µê·€
          } else {
            const baseSec = DEFAULT_MINUTES * 60;
            update(tRef, { status: "ëŒ€ê¸°", endAt: null, remaining: baseSec, ack: false });
            setCellBlink(key,false);   // ë‘ ë²ˆì§¸ í´ë¦­ë„ í°ìƒ‰ ìœ ì§€
          }
        }
      }, { onlyOnce: true });
    };

    /* ===== ì¶”ë‚˜ O/X ===== */
    window.toggleChuna = (key, onFlag) => {
      set(ref(db, `${roomPath()}/chuna/${key}`), { on:onFlag, at: serverTimestamp() });
    };

    /* ===== í–‰ ì´ˆê¸°í™” ===== */
    window.resetRow = (rowIndex) => {
      const basePath = roomPath();

      // í–‰ ê¸°ë³¸ ì •ë³´ ì´ˆê¸°í™”
      update(ref(db, `${basePath}/rows/${rowIndex}`), {
        dept:"",
        name:""
      });

      // 3ê°œ ì¹˜ë£Œ íƒ€ì´ë¨¸ ì´ˆê¸°í™”
      COLS.forEach((colName, j) => {
        const key = `r${rowIndex}_c${j}`;
        update(ref(db, `${basePath}/timers/${key}`), {
          status:"ëŒ€ê¸°",
          endAt:null,
          remaining:0,
          ack:false
        });
        setCellBlink(key,false);
      });

      // ì¶”ë‚˜ ì´ˆê¸°í™”
      const chunaKey = `r${rowIndex}_c3`;
      set(ref(db, `${basePath}/chuna/${chunaKey}`), {
        on:false,
        at: serverTimestamp()
      });

      // UI ì¦‰ì‹œ ë°˜ì˜
      const tr = document.getElementById("row-"+rowIndex);
      if (tr){
        const sel = tr.querySelector("select.doctor");
        if (sel) sel.value = "";
        tr.style.background = "";
        tr.classList.add("no-doctor");

        const nameTd = tr.children[1];
        if (nameTd) nameTd.textContent = `<${rowIndex}ë²ˆ ë² ë“œ> /`;

        updateYangbangCell(rowIndex, "");
      }
    };

    /* (êµ¬) ë¹„í”„ 5ì´ˆ ì¬ìƒ í•¨ìˆ˜ - í˜„ì¬ëŠ” ì‚¬ìš© ì•ˆ í•¨ */
    function playBeepOnce(){ try{ beep.currentTime = 0; beep.play(); }catch(e){} }
    function playBeepFor5Sec(enabled){
      if (!enabled) return;
      let count = 0;
      playBeepOnce();
      const intv = setInterval(()=>{
        count++;
        if (count >= 5){ clearInterval(intv); return; }
        playBeepOnce();
      }, 1000);
    }

    /* ===== í˜¸ì¶œ í† ê¸€ ===== */
    window.toggleCall = (floor, dept) => {
      if (role==='nurse' && floor !== currentFloor) return; // ê°„í˜¸ì‚¬ëŠ” ìê¸° ì¸µë§Œ
      const cRef = ref(db, `rooms/${floor}/nurseCalls/${dept}`);
      onValue(cRef, (snap)=>{
        const cur = !!(snap.val() && snap.val().on);
        const next = !cur;
        set(cRef, { on: next, at: serverTimestamp() });
        if (next && listenChannels[dept]) {
          // í˜¸ì¶œìŒ: 1ë²ˆë§Œ ì¬ìƒ
          playCallSound();
        }
      }, { onlyOnce:true });
    };

    /* ===== ì¸µ ë°ì´í„° ë¦¬ìŠ¤ë„ˆ ===== */
    let floorRefs = [];
    function attachFloorListeners(){
      const rowsRef   = ref(db, `${roomPath()}/rows`);
      const timersRef = ref(db, `${roomPath()}/timers`);
      const chunaRef  = ref(db, `${roomPath()}/chuna`);
      floorRefs = [rowsRef, timersRef, chunaRef];

      onValue(rowsRef, (snap) => {
        const rows = snap.val() || {};
        for (let i=1;i<=ROW_COUNT;i++){
          const r  = rows[i] || {};
          const tr = document.getElementById("row-"+i);
          if (!tr) continue;
          const sel = tr.querySelector("select.doctor");
          if (sel && sel.value !== (r.dept||"")) sel.value = r.dept||"";
          tr.style.background = deptColors[r.dept||""] || "";

          /* âœ… ë‹´ë‹¹ ë¯¸ì„ íƒ ì‹œ ì‹œê°„Â·ë²„íŠ¼ ìˆ¨ê¹€ */
          tr.classList.toggle("no-doctor", !(r.dept && r.dept.length));

          // ì–‘ë°©ì´ë©´ ì¹¨ì¹˜ë£Œ ë°•ìŠ¤ ìˆ¨ê¹€(í­ ìœ ì§€)
          updateYangbangCell(i, r.dept || "");

          const nameTd = tr.children[1];
          const placeholder = `<${i}ë²ˆ ë² ë“œ> /`;
          if (typeof r.name === "string" && r.name.length>0){
            if (nameTd.textContent !== r.name) nameTd.textContent = r.name;
          } else {
            if (nameTd.textContent !== placeholder) nameTd.textContent = placeholder;
          }
        }
      });

      onValue(timersRef, (snap) => {
        const timers = snap.val() || {};
        Object.entries(timers).forEach(([key, v]) => {
          const st = document.getElementById("status-"+key);
          const tt = document.getElementById("time-"+key);
          const box = document.getElementById("box-"+key);
          if (!st || !tt || !box) return;

          const status = v.status || "ëŒ€ê¸°";
          const ack    = !!v.ack;

          st.textContent = status;
          st.className = "pill " + (status==="ì§„í–‰" ? "pill-run" : status==="ì™„ë£Œ" ? "pill-done" : "pill-wait");
          setCellBlink(key,false);

          if (intervals[key]) { clearInterval(intervals[key]); intervals[key]=null; }

          if (status === "ì§„í–‰" && v.endAt){
            const tick = () => {
              const remain = Math.max(0, Math.floor((v.endAt - Date.now())/1000));
              tt.textContent = fmt(remain);
              if (remain <= 0){
                clearInterval(intervals[key]); intervals[key]=null;
                st.textContent = "ì™„ë£Œ"; st.className = "pill pill-done";
                tt.textContent = "";
                // ì™„ë£ŒìŒ: 2ë²ˆ ì¬ìƒ
                playCompleteSound();
                update(ref(db, `${roomPath()}/timers/${key}`), { status: "ì™„ë£Œ", endAt: null, remaining: 0, ack:false });
                setCellBlink(key,true);   // ì™„ë£Œ ì‹œ ë¶‰ì€ìƒ‰ ê¹œë¹¡ì„
              }
            };
            tick();
            intervals[key] = setInterval(tick, 250);
          } else {
            const base = DEFAULT_MINUTES;
            const remain = (typeof v.remaining === "number" && v.remaining>0) ? v.remaining : (status==="ì™„ë£Œ"?0:base*60);
            tt.textContent = (status==="ì™„ë£Œ") ? "" : (remain>0 ? fmt(remain) : "");
            if (status === "ì™„ë£Œ" && !ack){
              setCellBlink(key,true);    // ì™„ë£Œ + ë¯¸í™•ì¸ ìƒíƒœë©´ ê³„ì† ê¹œë¹¡
            } else {
              setCellBlink(key,false);   // ë‚˜ë¨¸ì§€ëŠ” í°ìƒ‰ ìœ ì§€
            }
          }
        });
      });

      onValue(chunaRef, (snap) => {
        const data = snap.val() || {};
        for (let i=1;i<=ROW_COUNT;i++){
          const key = `r${i}_c3`;
          const on = !!(data[key] && data[key].on);
          const st = document.getElementById("status-"+key);
          const oBtn = document.getElementById("ox-on-"+key);
          const xBtn = document.getElementById("ox-off-"+key);
          if (st) st.textContent = on ? "ì§„í–‰" : "ëŒ€ê¸°";
          if (st) st.className = "pill " + (on ? "pill-run" : "pill-wait");
          if (oBtn) oBtn.classList.toggle("ox-on", on);
          if (xBtn) xBtn.classList.remove("ox-on");
        }
      });
    }
    function teardownFloorListeners(){ floorRefs.forEach(r => off(r)); floorRefs = []; }

    /* ===== ê°„í˜¸ì‚¬ í˜¸ì¶œ ìˆ˜ì‹  ë¦¬ìŠ¤ë„ˆ (ë‘ ì¸µ ëª¨ë‘) ===== */
    let nurseRefs = [];
    function attachNurseListeners(){
      nurseRefs = FLOORS.map(f => ref(db, `rooms/${f}/nurseCalls`));
      nurseRefs.forEach((rf, idx) => onValue(rf, (snap)=>{
        const floor = FLOORS[idx];
        const c = snap.val() || {};
        DEPTS.forEach(dept=>{
          const on = !!(c[dept] && c[dept].on);
          const btn = document.getElementById(`call-${floor}-${dept}`);
          if (!btn) return;
          const wasOn = lastCallState2[floor][dept];
          btn.classList.toggle("on", on);
          btn.classList.toggle("blink-btn", on);
          if (on && !wasOn && listenChannels[dept]) {
            // í˜¸ì¶œìŒ: 1ë²ˆ ì¬ìƒ
            playCallSound();
          }
          lastCallState2[floor][dept] = on;
        });
      }));
    }
    function detachNurseListeners(){ nurseRefs.forEach(r => off(r)); nurseRefs = []; }
    function reattachNurseListeners(){ detachNurseListeners(); attachNurseListeners(); }

    function fmt(sec){ const m=Math.floor(sec/60), s=sec%60; return `${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`; }

    function buildTable(){
      const tbody = document.getElementById("tableBody"); tbody.innerHTML = "";
      for(let i=1;i<=ROW_COUNT;i++){
        const tr = document.createElement("tr"); tr.id = "row-"+i;
        /* ì´ˆê¸°ì—ëŠ” ë‹´ë‹¹ ë¯¸ì„ íƒ ìƒíƒœë¡œ ê°€ì • â†’ ì‹œê°„/ë²„íŠ¼ ìˆ¨ê¹€ í´ë˜ìŠ¤ ë¶€ì—¬ */
        tr.classList.add("no-doctor");

        /* ë‹´ë‹¹(ì£¼ì¹˜ì˜ ì„ íƒ) */
        const docTd = document.createElement("td");
        docTd.innerHTML = `
          <div>
            <select class="doctor" style="width:100%;padding:12px 14px;font-size:30px;border-radius:10px;"
              onchange="changeDoctor(${i}, this.value)">
              <option value="">ì„ íƒ</option>
              ${DEPTS.map(d=>`<option value="${d}">${d}</option>`).join('')}
            </select>
          </div>`;
        tr.appendChild(docTd);

        /* ì´ë¦„ */
        const nameTd = document.createElement("td");
        nameTd.className = "name-cell";
        nameTd.textContent = `<${i}ë²ˆ ë² ë“œ> /`;
        nameTd.contentEditable = true;
        nameTd.addEventListener("blur", () => { update(ref(db, `${roomPath()}/rows/${i}`), { name: nameTd.textContent }); });
        tr.appendChild(nameTd);

        /* ì¹˜ë£Œ 3ì¹¸ */
        COLS.forEach((colName, j) => {
          const key = `r${i}_c${j}`;
          const td  = document.createElement("td");
          td.className = "therapy-cell";
          td.dataset.col = colName;
          td.innerHTML = `
            <div class="status-box" id="box-${key}" onclick="onBoxClick('${key}')">
              <div class="left-col">
                <span class="pill pill-wait" id="status-${key}">ëŒ€ê¸°</span>
                <span class="time-text" id="time-${key}"></span>
              </div>
              <div class="right-col">
                <button class="mini-btn mini-start" onclick="startTimer('${key}', '${colName}'); event.stopPropagation();">ì§„í–‰</button>
                <button class="mini-btn mini-stop"  onclick="stopTimer('${key}'); event.stopPropagation();">ì¤‘ì§€</button>
                <div class="adjust-box">
                  <button class="btn-adjust" onclick="adjustTime('${key}', 30); event.stopPropagation();">+</button>
                  <button class="btn-adjust" onclick="adjustTime('${key}',-30); event.stopPropagation();">-</button>
                </div>
              </div>
            </div>`;
          tr.appendChild(td);
        });

        /* ì¶”ë‚˜ */
        const chunaKey = `r${i}_c3`;
        const chunaTd  = document.createElement("td");
        chunaTd.className = "chuna-cell";
        chunaTd.innerHTML = `
          <div class="chuna-box" id="box-${chunaKey}">
            <div class="left-col">
              <span class="pill pill-wait" id="status-${chunaKey}" style="font-size:20px;">ëŒ€ê¸°</span>
            </div>
            <div class="ox-group">
              <button class="ox-btn" id="ox-on-${chunaKey}"  onclick="toggleChuna('${chunaKey}', true)">O</button>
              <button class="ox-btn" id="ox-off-${chunaKey}" onclick="toggleChuna('${chunaKey}', false)">X</button>
              <button class="reset-btn" onclick="resetRow(${i})">ì´ˆê¸°í™”</button>
            </div>
          </div>`;
        tr.appendChild(chunaTd);

        tbody.appendChild(tr);
      }
    }

    buildTable();
    attachFloorListeners();
    attachNurseListeners();
  </script>
</body>
</html>
