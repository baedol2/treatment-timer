<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<title>ì¹˜ë£Œì‹¤ íƒ€ì´ë¨¸ ë³´ë“œ</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<style>
body {
  font-family: "Noto Sans KR", sans-serif;
  background: #f5f7fb;
  margin: 0;
  padding: 90px 14px 20px 14px;
}
h2 {
  margin: 0 0 12px;
  font-size: 26px;
}

/* ìƒë‹¨ ë©”ë‰´ */
.topbar {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  align-items: center;
  margin-bottom: 10px;
}
.grow { flex: 1 1 auto; }

.sound-btn, .danger-btn {
  border: none;
  border-radius: 30px;
  padding: 10px 18px;
  font-size: 18px;
  cursor: pointer;
  font-weight: 700;
  background: #f1f3f5;
  box-shadow: 0 2px 6px rgba(0,0,0,0.05);
}
.sound-btn.on { outline: 3px solid #4caf50; }
.sound-btn.off { outline: 3px solid #999; background: #eee; color: #666; }

.danger-btn {
  background: #ffe1e1;
  color: #a90000;
  border: 1px solid #ffabab;
}

/* í…Œì´ë¸” */
table {
  width: 100%;
  border-collapse: collapse;
  background: #fff;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}
thead {
  background: #4b0082;
  color: #fff;
  font-size: 20px;
}
th, td {
  border: 1px solid #dcdcdc;
  padding: 10px 8px;
  text-align: center;
  font-size: 18px;
}
td:nth-child(2) { text-align: left; }

/* í™˜ì ì´ë¦„ */
.name-cell {
  font-size: 26px;
  font-weight: 700;
  padding: 14px 8px;
}

/* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
.mini-btn, .btn-adjust {
  font-size: 20px;
  font-weight: 700;
  border: none;
  border-radius: 8px;
  cursor: pointer;
}
.mini-btn { padding: 10px 18px; }
.btn-adjust {
  width: 44px; height: 44px;
  border: 2px solid #bbb;
  font-size: 26px;
}

.mini-start { background: #007bff; color: white; }
.mini-stop  { background: #ffca28; color: black; }

/* íƒ€ì´ë¨¸ í‘œì‹œ */
.time-text {
  font-size: 26px;
  font-weight: 900;
  color: #d9534f;
}

/* ìƒíƒœ ë¼ë²¨ */
.pill {
  padding: 6px 16px;
  border-radius: 18px;
  font-size: 18px;
  font-weight: 700;
}
.pill-wait { background: #fafafa; border: 2px solid #ccc; }
.pill-run  { background: #ffe680; color: #000; }
.pill-done { background: #ff8a80; color: white; }

/* ì™„ë£Œ ê¹œë¹¡ì„ */
@keyframes blinkCell {
  0% { box-shadow: 0 0 0 0 rgba(255,0,0,.25); }
  50%{ box-shadow: 0 0 0 14px rgba(255,0,0,.12); }
  100%{box-shadow: 0 0 0 0 rgba(255,0,0,.25);}
}
.cell-blink { animation: blinkCell 1s infinite; background:#fff3f3; }

/* ì…ì› / ì™¸ë˜ ë²„íŠ¼ */
.visit-btn {
  font-size: 14px;
  padding: 4px 8px;
  border-radius: 6px;
  border: 1px solid #aaa;
  cursor: pointer;
}
.visit-on { background:#2ecc71;color:white;border-color:#2ecc71; }
.visit-outon { background:#3498db;color:white;border-color:#3498db; }

/* ì¶”ë‚˜ O/X ë²„íŠ¼ */
.chuna-btn {
  font-size: 26px;
  font-weight: 900;
  border: 2px solid #444;
  border-radius: 10px;
  width: 55px;
  height: 55px;
  cursor: pointer;
}
.chuna-on  { background:#2ecc71; color:white; border-color:#27ae60; }
.chuna-off { background:#ff6b6b; color:white; border-color:#c0392b; }

/* ê³ ì • ê°„í˜¸ì‚¬ í˜¸ì¶œ íŒ¨ë„ */
.nurse-panel {
  position: fixed;
  top: 10px; right: 10px;
  background: white;
  border: 2px solid #ddd;
  border-radius: 30px;
  padding: 12px 14px;
  display: flex; gap: 10px;
  z-index: 9999;
}
.btn-call {
  padding: 10px 20px;
  font-size: 18px;
  border-radius: 25px;
  border: none;
  background:#f1f3f5;
  cursor:pointer; font-weight:700;
}
.btn-call.on { outline:3px solid #ff4d4f;background:#ffe6e6; }
@keyframes blinkBtn {0%{background:#ffe6e6;}50%{background:#ffb3b3;}100%{background:#ffe6e6;}}
.blink-btn { animation: blinkBtn .7s infinite; }

.status-box { display:flex;align-items:center;justify-content:space-between; }
.left-col, .right-col { display:flex; gap:10px; align-items:center; }
</style>
</head>

<body>
<!-- ìƒë‹¨ ë©”ë‰´ -->
<div class="topbar">
  <h2>ğŸ¥ ì¹˜ë£Œì‹¤ íƒ€ì´ë¨¸íŒ (12ë³‘ìƒ)</h2>
  <div class="grow"></div>

  <button id="btnCompleteSound" class="sound-btn on" onclick="toggleCompleteSound()">ì™„ë£ŒìŒ: ON</button>
  <button id="btnNurseSound" class="sound-btn on" onclick="toggleNurseSound()">í˜¸ì¶œìŒ: ON</button>

  <span style="font-weight:700;">ìˆ˜ì‹ :</span>
  <button class="sound-btn" data-dept="ëŒ€í‘œ" onclick="toggleListen('ëŒ€í‘œ')">ëŒ€í‘œ</button>
  <button class="sound-btn" data-dept="ì–‘ë°©" onclick="toggleListen('ì–‘ë°©')">ì–‘ë°©</button>
  <button class="sound-btn" data-dept="1ê³¼" onclick="toggleListen('1ê³¼')">1ê³¼</button>
  <button class="sound-btn" data-dept="2ê³¼" onclick="toggleListen('2ê³¼')">2ê³¼</button>
  <button class="sound-btn" data-dept="3ê³¼" onclick="toggleListen('3ê³¼')">3ê³¼</button>

  <button class="danger-btn" onclick="resetSettings()">âš™ ì´ˆê¸°í™”</button>
</div>

<!-- ê¸°ë³¸ì‹œê°„ -->
<div style="margin-bottom:10px;">
  <span style="font-size:18px;">ê¸°ë³¸ ì‹œê°„(ë¶„):</span>
  <input type="number" id="defaultMinutes" value="10" min="1" style="font-size:20px;padding:8px;width:90px;border-radius:6px;" />
  <button class="sound-btn" style="background:#007bff;color:white;" onclick="applyDefaultMinutes()">ì ìš©</button>
</div>

<!-- í…Œì´ë¸” -->
<table>
<thead>
<tr>
  <th>ë‹´ë‹¹</th>
  <th>í™˜ì</th>
  <th>í•«íŒ©</th>
  <th>ë¬¼ë¦¬ì¹˜ë£Œ</th>
  <th>ì¹¨ì¹˜ë£Œ</th>
  <th>ì¶”ë‚˜</th>
</tr>
</thead>
<tbody id="tableBody"></tbody>
</table>

<!-- ê°„í˜¸ì‚¬ í˜¸ì¶œ -->
<div class="nurse-panel">
  <button class="btn-call" id="call-ëŒ€í‘œ" onclick="toggleCall('ëŒ€í‘œ')">ëŒ€í‘œ</button>
  <button class="btn-call" id="call-ì–‘ë°©" onclick="toggleCall('ì–‘ë°©')">ì–‘ë°©</button>
  <button class="btn-call" id="call-1ê³¼" onclick="toggleCall('1ê³¼')">1ê³¼</button>
  <button class="btn-call" id="call-2ê³¼" onclick="toggleCall('2ê³¼')">2ê³¼</button>
  <button class="btn-call" id="call-3ê³¼" onclick="toggleCall('3ê³¼')">3ê³¼</button>
</div>

<audio id="beep" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg"></audio>

<!-- âœ… ì „ì²´ JS -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
import { getDatabase, ref, set, update, onValue, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-database.js";

/* Firebase ì„¤ì • */
const firebaseConfig = {
  apiKey: "AIzaSyCDPfyuS-lXHkkmbHEkE2sqFBkBvb_zhVg",
  authDomain: "treatment-timer.firebaseapp.com",
  databaseURL: "https://treatment-timer-default-rtdb.asia-southeast1.firebasedatabase.app/",
  projectId: "treatment-timer",
  storageBucket: "treatment-timer.firebasestorage.app",
  messagingSenderId: "723002106763",
  appId: "1:723002106763:web:0b6aa89d5c42acc2f0458e",
  measurementId: "G-VV9B5R5EZL"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* ì„¤ì • */
let DEFAULT_MINUTES = 10;
const ROW_COUNT = 12;
const COLS = ["í•«íŒ©","ë¬¼ë¦¬ì¹˜ë£Œ","ì¹¨ì¹˜ë£Œ"];
const ROOM = "rooms/default";

/* local ì„¤ì • */
let completeSoundOn = JSON.parse(localStorage.getItem("completeSoundOn")||"true");
let nurseSoundOn = JSON.parse(localStorage.getItem("nurseSoundOn")||"true");
let listenChannels = JSON.parse(localStorage.getItem("listenChannels")||"{}");
["ëŒ€í‘œ","ì–‘ë°©","1ê³¼","2ê³¼","3ê³¼"].forEach(d=>{ if(typeof listenChannels[d]!="boolean") listenChannels[d]=false; });

function saveLocal(){ localStorage.setItem("listenChannels",JSON.stringify(listenChannels)); localStorage.setItem("completeSoundOn",completeSoundOn); localStorage.setItem("nurseSoundOn",nurseSoundOn); }

/* UI state */
function applySoundButtons(){
  const c = document.getElementById("btnCompleteSound");
  const n = document.getElementById("btnNurseSound");
  c.classList.toggle("on", completeSoundOn);
  n.classList.toggle("on", nurseSoundOn);
  c.classList.toggle("off", !completeSoundOn);
  n.classList.toggle("off", !nurseSoundOn);
  c.textContent = `ì™„ë£ŒìŒ: ${completeSoundOn?"ON":"OFF"}`;
  n.textContent = `í˜¸ì¶œìŒ: ${nurseSoundOn?"ON":"OFF"}`;
}
applySoundButtons();

function toggleCompleteSound(){ completeSoundOn=!completeSoundOn; saveLocal(); applySoundButtons(); }
function toggleNurseSound(){ nurseSoundOn=!nurseSoundOn; saveLocal(); applySoundButtons(); }
window.toggleCompleteSound = toggleCompleteSound;
window.toggleNurseSound = toggleNurseSound;

function toggleListen(dept){
  listenChannels[dept] = !listenChannels[dept];
  saveLocal();
  document.querySelector(`[data-dept="${dept}"]`).classList.toggle("on", listenChannels[dept]);
}
window.toggleListen = toggleListen;

function resetSettings(){ localStorage.clear(); location.reload(); }
window.resetSettings = resetSettings;

window.applyDefaultMinutes = ()=>{
  const v = parseInt(document.getElementById("defaultMinutes").value);
  if(!isNaN(v)&&v>0) DEFAULT_MINUTES=v;
};

/* UI build */
function buildTable(){
  const tbody = document.getElementById("tableBody");
  for(let i=1;i<=ROW_COUNT;i++){
    const tr=document.createElement("tr"); tr.id=`row-${i}`;

    /* ë‹´ë‹¹ */
    const docTd=document.createElement("td");
    docTd.innerHTML=`
      <div style="display:flex;flex-direction:column;gap:3px;align-items:center;">
        <select id="doc-${i}" style="font-size:18px;padding:4px;" onchange="changeDoctor(${i},this.value)">
          <option value="">ì„ íƒ</option>
          <option value="ëŒ€í‘œ">ëŒ€í‘œ</option>
          <option value="ì–‘ë°©">ì–‘ë°©</option>
          <option value="1ê³¼">1ê³¼</option>
          <option value="2ê³¼">2ê³¼</option>
          <option value="3ê³¼">3ê³¼</option>
        </select>
        <div style="display:flex;gap:4px;">
          <button id="in-${i}" class="visit-btn" onclick="setVisitType(${i},'ì…ì›')">ì…ì›</button>
          <button id="out-${i}" class="visit-btn" onclick="setVisitType(${i},'ì™¸ë˜')">ì™¸ë˜</button>
        </div>
      </div>`;
    tr.appendChild(docTd);

    /* ì´ë¦„ */
    const nameTd=document.createElement("td");
    nameTd.className="name-cell";
    nameTd.textContent = `<${i}ë²ˆ>`;
    nameTd.contentEditable = true;
    nameTd.onblur=()=>update(ref(db,`${ROOM}/rows/${i}`),{name:nameTd.textContent});
    tr.appendChild(nameTd);

    /* 3ê°œ íƒ€ì´ë¨¸ ì»¬ëŸ¼ */
    COLS.forEach((col,j)=>{
      const key=`r${i}_c${j}`;
      const td=document.createElement("td");
      td.innerHTML=`
      <div class="status-box" id="box-${key}" onclick="resetDone('${key}')">
        <div class="left-col">
          <span class="time-text" id="time-${key}"></span>
        </div>
        <div class="right-col">
          <span class="pill pill-wait" id="status-${key}">ëŒ€ê¸°</span>
          <button class="btn-adjust" onclick="adjustTime('${key}',30);event.stopPropagation();">+</button>
          <button class="btn-adjust" onclick="adjustTime('${key}',-30);event.stopPropagation();">-</button>
          <button class="mini-btn mini-start" onclick="startTimer('${key}','${col}');event.stopPropagation();">ì§„í–‰</button>
          <button class="mini-btn mini-stop" onclick="stopTimer('${key}');event.stopPropagation();">ì¤‘ì§€</button>
        </div>
      </div>`;
      tr.appendChild(td);
    });

    /* ì¶”ë‚˜ O/X */
    const cTd=document.createElement("td");
    cTd.innerHTML=`
      <button id="chuna-${i}" class="chuna-btn chuna-off" onclick="toggleChuna(${i})">X</button>
    `;
    tr.appendChild(cTd);

    tbody.appendChild(tr);
  }
}
buildTable();

/* Firebase sync */
window.changeDoctor = (i,dept)=>update(ref(db,`${ROOM}/rows/${i}`),{dept});
window.setVisitType = (i,type)=>update(ref(db,`${ROOM}/rows/${i}`),{visitType:type});

/* ì¶”ë‚˜ O/X */
window.toggleChuna = (i)=>{
  const el=document.getElementById(`chuna-${i}`);
  const now=el.textContent==="O"?"X":"O";
  el.textContent=now;
  el.classList.toggle("chuna-on", now==="O");
  el.classList.toggle("chuna-off", now==="X");
  update(ref(db,`${ROOM}/rows/${i}`),{chuna:now});
};

/* íƒ€ì´ë¨¸ */
window.startTimer = (key,col)=>{
  const base = (col==="ì¶”ë‚˜")?0:DEFAULT_MINUTES;
  onValue(ref(db,`${ROOM}/timers/${key}`),(snap)=>{
    const v=snap.val()||{};
    const remain = (v.remaining>0)?v.remaining:(base*60);
    update(ref(db,`${ROOM}/timers/${key}`),{status:"ì§„í–‰",endAt:Date.now()+remain*1000});
  },{onlyOnce:true});
};

window.stopTimer = (key)=>{
  update(ref(db,`${ROOM}/timers/${key}`),{status:"ëŒ€ê¸°",endAt:null,remaining:0});
};

window.resetDone = (key)=>{
  const st=document.getElementById(`status-${key}`);
  if(st.textContent==="ì™„ë£Œ") stopTimer(key);
};

window.adjustTime = (key,sec)=>{
  onValue(ref(db,`${ROOM}/timers/${key}`),(snap)=>{
    const v=snap.val()||{};
    if(v.status==="ì§„í–‰"&&v.endAt){
      update(ref(db,`${ROOM}/timers/${key}`),{endAt:v.endAt+(sec*1000)});
    } else {
      const base=v.remaining||(DEFAULT_MINUTES*60);
      const newSec=Math.max(30,base+sec);
      update(ref(db,`${ROOM}/timers/${key}`),{remaining:newSec});
    }
  },{onlyOnce:true});
};

/* ê°„í˜¸ì‚¬ í˜¸ì¶œ */
window.toggleCall = (dept)=>{
  onValue(ref(db,`${ROOM}/nurseCalls/${dept}`),(snap)=>{
    const next=!(snap.val()&&snap.val().on);
    set(ref(db,`${ROOM}/nurseCalls/${dept}`),{on:next,at:serverTimestamp()});
  },{onlyOnce:true});
};

function beepOnce(){ const b=document.getElementById("beep"); try{b.currentTime=0;b.play();}catch{} }
function play10(){ if(!completeSoundOn) return; let c=0; const i=setInterval(()=>{beepOnce(); if(++c>=10)clearInterval(i);},1000); }

/* Firebase events */
onValue(ref(db,`${ROOM}/rows`),(snap)=>{
  const rows=snap.val()||{};
  for(let i=1;i<=ROW_COUNT;i++){
    const r=rows[i]||{};
    const name=document.querySelector(`#row-${i} td.name-cell`);
    if(r.name) name.textContent=r.name;

    const sel=document.getElementById(`doc-${i}`);
    if(r.dept && sel.value!==r.dept) sel.value=r.dept;

    const inB=document.getElementById(`in-${i}`);
    const outB=document.getElementById(`out-${i}`);
    if(r.visitType==="ì…ì›"){ inB.classList.add("visit-on"); outB.classList.remove("visit-outon"); }
    else if(r.visitType==="ì™¸ë˜"){ outB.classList.add("visit-outon"); inB.classList.remove("visit-on"); }
    else { inB.classList.remove("visit-on"); outB.classList.remove("visit-outon"); }

    const chu=document.getElementById(`chuna-${i}`);
    if(r.chuna==="O"){ chu.textContent="O"; chu.classList.add("chuna-on"); chu.classList.remove("chuna-off"); }
    else { chu.textContent="X"; chu.classList.add("chuna-off"); chu.classList.remove("chuna-on"); }
  }
});

onValue(ref(db,`${ROOM}/timers`),(snap)=>{
  const t=snap.val()||{};
  Object.entries(t).forEach(([key,v])=>{
    const st=document.getElementById(`status-${key}`);
    const tt=document.getElementById(`time-${key}`);
    const box=document.getElementById(`box-${key}`);
    if(!st||!tt||!box) return;

    if(v.status==="ì§„í–‰"&&v.endAt){
      const run=()=>{
        const remain=Math.max(0,Math.floor((v.endAt-Date.now())/1000));
        tt.textContent=`${String(Math.floor(remain/60)).padStart(2,"0")}:${String(remain%60).padStart(2,"0")}`;
        if(remain<=0){
          st.textContent="ì™„ë£Œ";
          st.className="pill pill-done";
          box.classList.add("cell-blink");
          tt.textContent="";
          play10();
          update(ref(db,`${ROOM}/timers/${key}`),{status:"ì™„ë£Œ",endAt:null,remaining:0});
          clearInterval(window[`_i_${key}`]);
        }
      };
      run();
      clearInterval(window[`_i_${key}`]);
      window[`_i_${key}`]=setInterval(run,250);
      st.textContent="ì§„í–‰"; st.className="pill pill-run"; box.classList.remove("cell-blink");
    } else if(v.status==="ëŒ€ê¸°"){
      st.textContent="ëŒ€ê¸°"; st.className="pill pill-wait"; box.classList.remove("cell-blink");
      tt.textContent=v.remaining?`${String(Math.floor(v.remaining/60)).padStart(2,"0")}:${String(v.remaining%60).padStart(2,"0")}`:"";
    }
  });
});

/* í˜¸ì¶œìŒ */
onValue(ref(db,`${ROOM}/nurseCalls`),(snap)=>{
  const c=snap.val()||{};
  ["ëŒ€í‘œ","ì–‘ë°©","1ê³¼","2ê³¼","3ê³¼"].forEach(dept=>{
    const btn=document.getElementById(`call-${dept}`);
    const on=c[dept]&&c[dept].on;
    btn.classList.toggle("on",on);
    btn.classList.toggle("blink-btn",on);

    if(on && nurseSoundOn && listenChannels[dept]){
      beepOnce();
      const int=setInterval(()=>{if(nurseSoundOn && listenChannels[dept]) beepOnce();},1000);
      setTimeout(()=>clearInterval(int),10000);
    }
  });
});
</script>
</body>
</html>
