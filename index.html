<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>치료실 타이머 보드</title>
  <style>
    body { font-family: Pretendard, sans-serif; background: #fafafa; margin: 0; padding: 0; }
    table { border-collapse: collapse; width: 100%; text-align: center; }
    th, td { border: 1px solid #ddd; padding: 8px; }
    th { background: #f0f0f0; }
    tr.blink-row { animation: blinkRow 1s infinite alternate; }
    @keyframes blinkRow { from { background-color: inherit; } to { background-color: #ffe4e1; } }
    .pill { padding: 3px 8px; border-radius: 8px; font-size: 0.8rem; }
    .pill-wait { background: #eee; color: #333; }
    .pill-run { background: #3498db; color: white; }
    .pill-done { background: #27ae60; color: white; }
    .blink-btn { animation: blinkBtn 1s infinite alternate; }
    @keyframes blinkBtn { from { background-color: #ffb6b6; } to { background-color: #ff0000; color: #fff; } }
    .nurse-buttons { position: fixed; top: 10px; right: 10px; display: flex; gap: 5px; }
    .nurse-buttons button { padding: 6px 12px; border-radius: 6px; border: none; cursor: pointer; }
  </style>
</head>
<body>
  <h2 style="text-align:center;">치료실 타이머 보드</h2>
  <div style="text-align:center;margin-bottom:10px;">
    <label>기본 시간(분): <input id="defaultMinutes" type="number" value="10" style="width:60px;text-align:center;"></label>
    <button onclick="applyDefaultMinutes()">설정</button>
  </div>

  <div class="nurse-buttons">
    <button id="call-대표" onclick="toggleCall('대표')">대표</button>
    <button id="call-양방" onclick="toggleCall('양방')">양방</button>
    <button id="call-1과" onclick="toggleCall('1과')">1과</button>
    <button id="call-2과" onclick="toggleCall('2과')">2과</button>
    <button id="call-3과" onclick="toggleCall('3과')">3과</button>
  </div>

  <audio id="alarmSound" src="https://cdn.pixabay.com/audio/2022/03/15/audio_9d9a4b4b67.mp3"></audio>

  <table>
    <thead>
      <tr>
        <th>담당</th>
        <th>환자</th>
        <th>핫팩</th>
        <th>물리치료</th>
        <th>침치료</th>
        <th>추나</th>
      </tr>
    </thead>
    <tbody id="tableBody"></tbody>
  </table>

  <!-- ✅ Firebase + 실시간 동기화 코드 -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getDatabase, ref, update, onValue, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCDPfyuS-lXHkkmbHEkE2sqFBkBvb_zhVg",
      authDomain: "treatment-timer.firebaseapp.com",
      databaseURL: "https://treatment-timer-default-rtdb.asia-southeast1.firebasedatabase.app/",
      projectId: "treatment-timer",
      storageBucket: "treatment-timer.firebasestorage.app",
      messagingSenderId: "723002106763",
      appId: "1:723002106763:web:0b6aa89d5c42acc2f0458e",
      measurementId: "G-VV9B5R5EZL"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let DEFAULT_MINUTES = 10;
    const ROW_COUNT = 12;
    const COLS = ["핫팩", "물리치료", "침치료", "추나"];
    const sound = document.getElementById("alarmSound");
    const timers = {}, intervals = {};
    const blinkingDepts = new Set();
    const ROOM = "rooms/default";
    const deptColors = { "대표": "#ffe8e8", "양방": "#e8f8ff", "1과": "#e8ffe8", "2과": "#fffde8", "3과": "#f3e8ff" };

    function buildTable() {
      const tbody = document.getElementById("tableBody");
      for (let i = 1; i <= ROW_COUNT; i++) {
        const tr = document.createElement("tr");
        tr.id = "row-" + i;
        const docTd = document.createElement("td");
        docTd.innerHTML = `
          <select class="doctor" onchange="changeDoctor(${i}, this.value)">
            <option value="">선택</option>
            <option value="대표">대표</option>
            <option value="양방">양방</option>
            <option value="1과">1과</option>
            <option value="2과">2과</option>
            <option value="3과">3과</option>
          </select>`;
        tr.appendChild(docTd);

        const nameTd = document.createElement("td");
        nameTd.textContent = i + "번 환자";
        nameTd.contentEditable = true;
        nameTd.addEventListener("blur", () => update(ref(db, `${ROOM}/rows/${i}`), { name: nameTd.textContent }));
        tr.appendChild(nameTd);

        COLS.forEach((col, j) => {
          const key = `r${i}_c${j}`;
          const td = document.createElement("td");
          td.innerHTML = `
            <div class="status-box" id="box-${key}">
              <span class="pill pill-wait" id="status-${key}">대기</span>
              <span class="time-text" id="time-${key}"></span>
              <div>
                <button onclick="startTimer('${key}', '${col}')">진행</button>
                <button onclick="stopTimer('${key}')">중지</button>
              </div>
            </div>`;
          tr.appendChild(td);
          timers[key] = { duration: 0, endAt: null, status: "대기" };
        });
        tbody.appendChild(tr);
      }
    }
    window.buildTable = buildTable;

    window.applyDefaultMinutes = () => {
      const v = parseInt(document.getElementById("defaultMinutes").value);
      if (!isNaN(v) && v > 0) DEFAULT_MINUTES = v;
      alert(`기본 시간 ${v}분으로 설정`);
    };

    window.changeDoctor = (i, dept) => {
      const tr = document.getElementById("row-" + i);
      tr.style.background = deptColors[dept] || "";
      update(ref(db, `${ROOM}/rows/${i}`), { dept });
    };

    window.startTimer = (key, col) => {
      const dur = (col === "추나" ? 5 : DEFAULT_MINUTES) * 60;
      const endAt = Date.now() + dur * 1000;
      update(ref(db, `${ROOM}/timers/${key}`), { status: "진행", endAt, duration: dur, startedAt: serverTimestamp() });
    };

    window.stopTimer = (key) => update(ref(db, `${ROOM}/timers/${key}`), { status: "대기", endAt: null });

    window.toggleCall = (dept) => {
      const btn = document.getElementById("call-" + dept);
      const active = !btn.classList.contains("on");
      update(ref(db, `${ROOM}/nurseCalls/${dept}`), { on: active });
    };

    onValue(ref(db, `${ROOM}/rows`), snap => {
      const rows = snap.val() || {};
      for (let i = 1; i <= ROW_COUNT; i++) {
        const r = rows[i] || {};
        const tr = document.getElementById("row-" + i);
        const sel = tr.querySelector("select");
        if (r.dept && sel.value !== r.dept) sel.value = r.dept;
        tr.style.background = deptColors[r.dept] || "";
        const nameTd = tr.querySelector("td:nth-child(2)");
        if (r.name && nameTd.textContent !== r.name) nameTd.textContent = r.name;
      }
    });

    onValue(ref(db, `${ROOM}/timers`), snap => {
      const t = snap.val() || {};
      Object.entries(t).forEach(([k, v]) => {
        const st = document.getElementById("status-" + k);
        const tt = document.getElementById("time-" + k);
        if (!st || !tt) return;
        st.textContent = v.status;
        st.className = "pill " + (v.status === "진행" ? "pill-run" : v.status === "완료" ? "pill-done" : "pill-wait");
        if (intervals[k]) clearInterval(intervals[k]);
        if (v.status === "진행" && v.endAt) {
          intervals[k] = setInterval(() => {
            const remain = Math.max(0, Math.floor((v.endAt - Date.now()) / 1000));
            tt.textContent = `${String(Math.floor(remain/60)).padStart(2,"0")}:${String(remain%60).padStart(2,"0")}`;
            if (remain <= 0) { clearInterval(intervals[k]); st.textContent="완료"; st.className="pill pill-done"; sound.play(); tt.textContent=""; }
          }, 1000);
        } else if (v.status === "대기") tt.textContent = v.duration ? `${Math.floor(v.duration/60)}:00` : "";
      });
    });

    onValue(ref(db, `${ROOM}/nurseCalls`), snap => {
      const c = snap.val() || {};
      ["대표","양방","1과","2과","3과"].forEach(d => {
        const b = document.getElementById("call-" + d);
        const on = c[d]?.on;
        b.classList.toggle("on", on);
        b.classList.toggle("blink-btn", on);
      });
    });

    buildTable();
  </script>
</body>
</html>
