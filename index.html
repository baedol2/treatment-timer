<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ì¹˜ë£Œì‹¤ íƒ€ì´ë¨¸ ë³´ë“œ v3.2 (í° ë²„íŠ¼/í° ì‹œê°„ í‘œì‹œ)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --purple:#4b0082;
      --yellow:#ffe08a;
      --dept-rep:#ffd9a3;
      --dept-west:#b6dcff;
      --dept-1:#d7c7ff;
      --dept-2:#c7ffd6;
      --dept-3:#ffc7eb;
    }
    body{ font-family:"Noto Sans KR",sans-serif; background:#f5f7fb; margin:0; padding:100px 14px 20px 14px; }
    h2{margin:0 0 12px; display:inline-block;}
    .topbar{ display:flex; flex-wrap:wrap; gap:12px; align-items:center; margin-bottom:12px; }
    .grow{ flex:1 1 auto; }
    .toolbar{ display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-bottom:12px; }
    .toolbar input{ padding:12px 14px; font-size:20px; border:1px solid #ccc; border-radius:12px; width:120px; }
    .btn{ border:none; border-radius:12px; padding:12px 18px; font-size:18px; cursor:pointer; }
    .btn-apply{ background:#007bff; color:#fff; }

    .sound-btn{
      border:none; border-radius:999px; padding:14px 20px; font-size:18px; cursor:pointer; font-weight:700;
      background:#f1f3f5; box-shadow:0 2px 6px rgba(0,0,0,0.05);
    }
    .sound-btn.on{ outline:3px solid #4caf50; } .sound-btn.off{ outline:3px solid #999; background:#f8f8f8; color:#666; }
    .sound-btn.chan.on{ outline:3px solid #4caf50; }

    .danger-btn{
      border:none; border-radius:999px; padding:14px 20px; font-size:18px; cursor:pointer; font-weight:700;
      background:#ffecec; color:#9b1c1c; box-shadow:0 2px 6px rgba(0,0,0,0.05); border:1px solid #f5b3b3;
    }

    .floor-tab{ border:none; border-radius:999px; padding:12px 18px; font-size:18px; cursor:pointer; background:#fff; }
    .floor-tab.on{ outline:3px solid #6c5ce7; background:#eee; }
    .role-chip{ border:none; border-radius:999px; padding:12px 18px; font-size:18px; cursor:pointer; background:#fff; }
    .role-chip.on{ outline:3px solid #00c853; background:#eaffea; }

    table{ width:100%; border-collapse:collapse; background:#fff; box-shadow:0 2px 8px rgba(0,0,0,0.03); }
    thead{ background:var(--purple); color:#fff; }
    th,td{ border:1px solid #ececec; padding:12px 10px; text-align:center; font-size:18px; }
    th:nth-child(1){ width:170px; }
    th:nth-child(2){ width:260px; text-align:center; } td:nth-child(2){ text-align:left; }
    .name-cell{ font-size:clamp(22px, 2.8vw, 38px); font-weight:800; line-height:1.2; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

    /* ====== ì»¤ë‹¤ë€ ì…€ ë ˆì´ì•„ì›ƒ ====== */
    .status-box{
      display:grid;
      grid-template-columns: 1fr auto; /* ì™¼ìª½: ì‹œê°„/ìƒíƒœ, ì˜¤ë¥¸ìª½: ì»¨íŠ¸ë¡¤ ë¬¶ìŒ */
      align-items:center;
      gap:16px;
      min-height:140px; /* ê¸°ì¡´ë³´ë‹¤ í¬ê²Œ */
      padding:14px 14px;
      border-radius:16px;
      background:#ffffff;
    }
    .left-col{ display:flex; align-items:center; gap:14px; }
    .time-text{
      font-weight:900;
      color:#d9534f;
      font-size:clamp(40px, 5.0vw, 56px); /* ë” í¬ê²Œ */
      min-width:96px;
      text-align:left;
      letter-spacing:1px;
    }
    .right-col{
      display:grid;
      grid-auto-flow:row;
      grid-template-columns: repeat(3, minmax(120px, 1fr));
      gap:12px;
      justify-content:end;
      align-content:center;
    }

    .pill{ display:inline-block; padding:10px 16px; border-radius:999px; font-size:18px; font-weight:900; }
    .pill-wait{ background:#fff; border:3px solid #ddd; color:#444; }
    .pill-run{ background:var(--yellow); color:#222; }
    .pill-done{ background:#ffb6b6; color:#681212; }

    .mini-btn{
      border:none; border-radius:16px;
      padding:18px 22px;
      font-size:28px;
      font-weight:900;
      cursor:pointer;
      width:100%; /* ì…€ ê°€ë“ ì°¨ë„ë¡ */
      height:72px;
    }
    .mini-start{ background:#0d6efd; color:#fff; }
    .mini-stop{  background:#ffc107; color:#222; }

    .adjust-box{ display:flex; flex-direction:column; gap:10px; justify-content:stretch; align-items:stretch; }
    .btn-adjust{
      background:#fff; border:3px solid #bdbdbd; border-radius:16px;
      width:100%;
      height:60px;
      font-size:28px;
      cursor:pointer;
      font-weight:900;
    }

    @keyframes cellBlink{0%{box-shadow:0 0 0 0 rgba(255,0,0,.22);}50%{box-shadow:0 0 0 18px rgba(255,0,0,.08);}100%{box-shadow:0 0 0 0 rgba(255,0,0,.22);} }
    .cell-blink{ animation:cellBlink 1s ease-in-out infinite; background:#fff8f8; }

    .nurse-panel{
      position:fixed; top:10px; left:10px; background:rgba(255,255,255,0.98);
      border:2px solid #dcdcdc; border-radius:999px; padding:20px 26px; box-shadow:0 12px 28px rgba(0,0,0,0.10);
      display:flex; gap:18px; align-items:center; z-index:1000;
    }
    .nurse-label{ font-size:28px; font-weight:900; margin-right:12px; white-space:nowrap; }
    .btn-call{ border:none; border-radius:999px; padding:20px 28px; font-size:28px; cursor:pointer; background:#f1f3f5; font-weight:900; white-space:nowrap; letter-spacing:.2px; box-shadow:0 3px 8px rgba(0,0,0,0.12); }
    .btn-call.on{ outline:3px solid #ff4d4f; background:#ffe6e6; }
    @keyframes blinkBtn{0%{background:#ffe6e6;transform:translateY(0)}50%{background:#ffb3b3;transform:translateY(-1px)}100%{background:#ffe6e6;transform:translateY(0)}}
    .blink-btn{ animation:blinkBtn .7s ease-in-out infinite; }

    .listen-group{ display:flex;gap:8px;align-items:center; flex-wrap:wrap; }

    .io-group{ display:flex; gap:10px; margin-top:10px; justify-content:center; }
    .io-btn{ border:3px solid #bbb; background:#fff; border-radius:999px; padding:8px 14px; font-size:16px; font-weight:900; cursor:pointer; }
    .io-btn.active{ background:#222; color:#fff; border-color:#222; }

    /* í™œì„±í™” ìƒ‰ìƒ ì§€ì •: ì…ì›=íŒŒë€ìƒ‰, ì™¸ë˜=ì´ˆë¡ìƒ‰ */
    .io-btn[data-type="ì…ì›"].active{ background:#0d6efd; color:#fff; border-color:#0d6efd; }
    .io-btn[data-type="ì™¸ë˜"].active{ background:#2e7d32; color:#fff; border-color:#2e7d32; }

    .chuna-box{
      display:flex; align-items:center; justify-content:space-between; gap:16px;
      min-height:140px; padding:14px 14px; border-radius:16px;
      background:#ffffff;
    }
    .ox-group{ display:flex; gap:16px; }
    .ox-btn{
      border:none; border-radius:16px; padding:16px 22px; font-size:28px; font-weight:900; cursor:pointer;
      box-shadow:0 2px 6px rgba(0,0,0,.06);
    }
    .ox-on{  background:#00c853; color:#fff; }
    .ox-off{ background:#e0e0e0; color:#111; }

    /* ì¡°ê¸ˆ ë” ë†’ì´ í™•ë³´: í–‰ ë†’ì´ ì—¬ë°± */
    tbody > tr > td { padding:8px; }
  </style>
</head>
<body>
  <div class="topbar">
    <h2>ğŸ¥ ì¹˜ë£Œì‹¤ íƒ€ì´ë¨¸íŒ (í° ë²„íŠ¼/í° ì‹œê°„)</h2>
    <div class="grow"></div>

    <div style="display:flex;gap:8px;align-items:center;">
      <button class="floor-tab" id="tab-1F" onclick="switchFloor('1F')">1ì¸µ</button>
      <button class="floor-tab" id="tab-2F" onclick="switchFloor('2F')">2ì¸µ</button>
    </div>

    <div style="display:flex;gap:8px;align-items:center;">
      <span style="font-weight:900;">ì—­í• :</span>
      <button class="role-chip" id="role-doctor" onclick="setRole('doctor')">ì˜ì‚¬</button>
      <button class="role-chip" id="role-nurse"  onclick="setRole('nurse')">ê°„í˜¸ì‚¬</button>
    </div>

    <button id="btnCompleteSound" class="sound-btn on" onclick="toggleCompleteSound()">ì™„ë£ŒìŒ: ON</button>
    <button id="btnNurseSound"    class="sound-btn on" onclick="toggleNurseSound()">í˜¸ì¶œìŒ: ON</button>

    <div class="listen-group">
      <span style="font-weight:900;">ìˆ˜ì‹  ì±„ë„:</span>
      <button class="sound-btn chan" data-dept="ëŒ€í‘œ" onclick="toggleListen('ëŒ€í‘œ')">ëŒ€í‘œ</button>
      <button class="sound-btn chan" data-dept="ì–‘ë°©" onclick="toggleListen('ì–‘ë°©')">ì–‘ë°©</button>
      <button class="sound-btn chan" data-dept="1ê³¼" onclick="toggleListen('1ê³¼')">1ê³¼</button>
      <button class="sound-btn chan" data-dept="2ê³¼" onclick="toggleListen('2ê³¼')">2ê³¼</button>
      <button class="sound-btn chan" data-dept="3ê³¼" onclick="toggleListen('3ê³¼')">3ê³¼</button>
    </div>

    <button class="danger-btn" onclick="resetSettings()">âš™ï¸ ì„¤ì • ì´ˆê¸°í™”</button>
  </div>

  <div class="toolbar">
    <span>ê¸°ë³¸ ì‹œê°„(ë¶„):</span>
    <input type="number" id="defaultMinutes" value="10" min="1" />
    <button class="btn btn-apply" onclick="applyDefaultMinutes()">ì ìš©</button>
    <small style="color:#666;">ì¶”ë‚˜ëŠ” íƒ€ì´ë¨¸ ëŒ€ì‹  O/Xë¡œ ì§„í–‰ ì—¬ë¶€ ì²´í¬ Â· ê° ì¹¸ì—ì„œ ï¼‹/- ì¡°ì •</small>
  </div>

  <table id="timerTable">
    <thead>
      <tr>
        <th>ë‹´ë‹¹<br><small>ì…ì›/ì™¸ë˜</small></th>
        <th>í™˜ìì´ë¦„</th>
        <th>í•«íŒ©</th>
        <th>ë¬¼ë¦¬ì¹˜ë£Œ</th>
        <th>ì¹¨ì¹˜ë£Œ</th>
        <th>ì¶”ë‚˜(O/X)</th>
      </tr>
    </thead>
    <tbody id="tableBody"></tbody>
  </table>

  <div class="nurse-panel">
    <span class="nurse-label">ê°„í˜¸ì‚¬ í˜¸ì¶œ</span>
    <button class="btn-call" id="call-ëŒ€í‘œ" onclick="toggleCall('ëŒ€í‘œ')">ëŒ€í‘œ</button>
    <button class="btn-call" id="call-ì–‘ë°©" onclick="toggleCall('ì–‘ë°©')">ì–‘ë°©</button>
    <button class="btn-call" id="call-1ê³¼" onclick="toggleCall('1ê³¼')">1ê³¼</button>
    <button class="btn-call" id="call-2ê³¼" onclick="toggleCall('2ê³¼')">2ê³¼</button>
    <button class="btn-call" id="call-3ê³¼" onclick="toggleCall('3ê³¼')">3ê³¼</button>
  </div>

  <audio id="beep" preload="auto" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg"></audio>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getDatabase, ref, set, update, onValue, off, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCDPfyuS-lXHkkmbHEkE2sqFBkBvb_zhVg",
      authDomain: "treatment-timer.firebaseapp.com",
      databaseURL: "https://treatment-timer-default-rtdb.asia-southeast1.firebasedatabase.app/",
      projectId: "treatment-timer",
      storageBucket: "treatment-timer.firebasestorage.app",
      messagingSenderId: "723002106763",
      appId: "1:723002106763:web:0b6aa89d5c42acc2f0458e",
      measurementId: "G-VV9B5R5EZL"
    };
    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);

    const FLOORS = ['1F','2F'];
    let currentFloor = new URLSearchParams(location.search).get('floor') || localStorage.getItem('currentFloor') || '1F';
    const ROLE_KEY = 'ttb_role';
    const roleParam = new URLSearchParams(location.search).get('role');
    if (roleParam === 'doctor' || roleParam === 'nurse') localStorage.setItem(ROLE_KEY, roleParam);
    let role = (localStorage.getItem(ROLE_KEY) || 'doctor'); // doctor | nurse

    let DEFAULT_MINUTES = 10;
    const ROW_COUNT = 12;
    const COLS = ["í•«íŒ©","ë¬¼ë¦¬ì¹˜ë£Œ","ì¹¨ì¹˜ë£Œ"];
    const deptColors = {"":"", "ëŒ€í‘œ":"var(--dept-rep)", "ì–‘ë°©":"var(--dept-west)", "1ê³¼":"var(--dept-1)", "2ê³¼":"var(--dept-2)", "3ê³¼":"var(--dept-3)"};

    const intervals = {};
    const lastCallState = {"ëŒ€í‘œ":false,"ì–‘ë°©":false,"1ê³¼":false,"2ê³¼":false,"3ê³¼":false};
    const nurseBeepTimers = {}; const nurseStopTimers  = {};
    const beep = document.getElementById('beep');

    let completeSoundOn = JSON.parse(localStorage.getItem('completeSoundOn') || 'true');
    let nurseSoundOn    = JSON.parse(localStorage.getItem('nurseSoundOn')    || 'true');
    let listenChannels  = JSON.parse(localStorage.getItem('listenChannels')  || '{}');
    ["ëŒ€í‘œ","ì–‘ë°©","1ê³¼","2ê³¼","3ê³¼"].forEach(d => { if (typeof listenChannels[d] !== 'boolean') listenChannels[d] = true; });

    function save(k,v){ localStorage.setItem(k, JSON.stringify(v)); }
    function applyListenUI(){
      ["ëŒ€í‘œ","ì–‘ë°©","1ê³¼","2ê³¼","3ê³¼"].forEach(d => {
        const btn = document.querySelector(`.sound-btn.chan[data-dept="${d}"]`);
        if (btn) btn.classList.toggle('on', !!listenChannels[d]);
      });
    }
    function applySoundButtons(){
      const b1 = document.getElementById('btnCompleteSound');
      const b2 = document.getElementById('btnNurseSound');
      if (b1) { b1.classList.toggle('on',  completeSoundOn); b1.classList.toggle('off', !completeSoundOn); b1.textContent = `ì™„ë£ŒìŒ: ${completeSoundOn?'ON':'OFF'}`; }
      if (b2) { b2.classList.toggle('on',  nurseSoundOn);    b2.classList.toggle('off', !nurseSoundOn);    b2.textContent = `í˜¸ì¶œìŒ: ${nurseSoundOn?'ON':'OFF'}`; }
    }
    function applyRoleUI(){
      document.getElementById('role-doctor')?.classList.toggle('on', role==='doctor');
      document.getElementById('role-nurse')?.classList.toggle('on',  role==='nurse');
    }
    function applyFloorTabs(){
      FLOORS.forEach(f => document.getElementById('tab-'+f)?.classList.toggle('on', f===currentFloor));
    }
    applyListenUI(); applySoundButtons(); applyRoleUI(); applyFloorTabs();

    window.toggleCompleteSound = () => { completeSoundOn = !completeSoundOn; save('completeSoundOn',completeSoundOn); applySoundButtons(); };
    window.toggleNurseSound    = () => { nurseSoundOn    = !nurseSoundOn;    save('nurseSoundOn',nurseSoundOn);    applySoundButtons(); if (!nurseSoundOn) stopAllNurseBeeps(); };
    window.toggleListen = (dept) => { listenChannels[dept] = !listenChannels[dept]; save('listenChannels',listenChannels); applyListenUI(); };
    window.resetSettings = () => { if (confirm("ì„¤ì •ì„ ëª¨ë‘ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) { localStorage.clear(); alert("ì„¤ì •ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤."); location.reload(); } };

    window.setRole = (r) => { if (r!=='doctor' && r!=='nurse') return; role=r; localStorage.setItem(ROLE_KEY, r); applyRoleUI(); reattachAllNurseListeners(); };
    window.switchFloor = (f) => {
      if (!FLOORS.includes(f)) return;
      currentFloor = f; localStorage.setItem('currentFloor', f); applyFloorTabs();
      teardownFloorListeners(); attachFloorListeners(); reattachAllNurseListeners();
    };

    window.applyDefaultMinutes = () => {
      const v = parseInt(document.getElementById("defaultMinutes").value);
      if (!isNaN(v) && v > 0) { DEFAULT_MINUTES = v; alert(`ê¸°ë³¸ ì‹œê°„ ${v}ë¶„ìœ¼ë¡œ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤.`); }
    };

    function roomPath(){ return `rooms/${currentFloor}`; }

    window.changeDoctor = (rowIndex, dept) => {
      update(ref(db, `${roomPath()}/rows/${rowIndex}`), { dept });
      const tr = document.getElementById("row-"+rowIndex);
      if (tr) tr.style.background = deptColors[dept] || "";
    };
    window.setInOut = (rowIndex, type) => { update(ref(db, `${roomPath()}/rows/${rowIndex}`), { inout:type }); };

    window.startTimer = (key, colName) => {
      const baseMin = DEFAULT_MINUTES;
      const tRef = ref(db, `${roomPath()}/timers/${key}`);
      update(tRef, { colName, status: "ì§„í–‰" });
      onValue(tRef, (snap) => {
        const v = snap.val() || {};
        const now = Date.now();
        const remainMs = (typeof v.remaining === "number" && v.remaining > 0) ? v.remaining * 1000 : baseMin * 60 * 1000;
        update(tRef, { endAt: now + remainMs, status: "ì§„í–‰" });
      }, { onlyOnce: true });
    };
    window.stopTimer = (key) => {
      const tRef = ref(db, `${roomPath()}/timers/${key}`);
      update(tRef, { status: "ëŒ€ê¸°", endAt: null, remaining: 0 });
      document.getElementById("box-"+key)?.classList.remove("cell-blink");
    };
    window.resetIfDone = (key) => {
      const st = document.getElementById("status-"+key);
      if (st && st.textContent === "ì™„ë£Œ") stopTimer(key);
    };
    window.adjustTime = (key, diffSec) => {
      const tRef = ref(db, `${roomPath()}/timers/${key}`);
      onValue(tRef, (snap) => {
        const v = snap.val() || {};
        const diffMs = diffSec * 1000;
        if (v.status === "ì§„í–‰" && v.endAt) {
          update(tRef, { endAt: v.endAt + diffMs });
        } else {
          const base = DEFAULT_MINUTES;
          const curSec = (typeof v.remaining === "number" && v.remaining > 0) ? v.remaining : base * 60;
          const nxtSec = Math.max(30, curSec + diffSec);
          update(tRef, { remaining: nxtSec });
        }
      }, { onlyOnce: true });
    };

    window.toggleChuna = (key, onFlag) => {
      set(ref(db, `${roomPath()}/chuna/${key}`), { on:onFlag, at: serverTimestamp() });
    };

    window.toggleCall = (dept) => {
      const cRef = ref(db, `${roomPath()}/nurseCalls/${dept}`);
      onValue(cRef, (snap) => {
        const next = !(snap.val() && snap.val().on);
        set(cRef, { on: next, at: serverTimestamp() });
      }, { onlyOnce: true });
    };

    function playBeepOnce(){ try{ beep.currentTime = 0; beep.play(); } catch(e){} }
    function playBeepFor10Sec_Complete(){
      if (!completeSoundOn) return;
      let count = 0;
      const doBeep = () => { try{ beep.currentTime = 0; beep.play(); } catch(e){} };
      doBeep();
      const intv = setInterval(()=>{ count++; if (count >= 9) { clearInterval(intv); return; } doBeep(); }, 1000);
    }
    function startNurseBeep(dept){
      if (nurseBeepTimers[dept]) clearInterval(nurseBeepTimers[dept]);
      if (nurseStopTimers[dept])  clearTimeout(nurseStopTimers[dept]);
      const doBeep = ()=>{ if (nurseSoundOn && listenChannels[dept]) playBeepOnce(); };
      doBeep();
      nurseBeepTimers[dept] = setInterval(doBeep, 1000);
      nurseStopTimers[dept]  = setTimeout(()=> stopNurseBeep(dept), 10000);
    }
    function stopNurseBeep(dept){ if (nurseBeepTimers[dept]){ clearInterval(nurseBeepTimers[dept]); nurseBeepTimers[dept]=null; } if (nurseStopTimers[dept]) { clearTimeout(nurseStopTimers[dept]); nurseStopTimers[dept]=null; } }
    function stopAllNurseBeeps(){ ["ëŒ€í‘œ","ì–‘ë°©","1ê³¼","2ê³¼","3ê³¼"].forEach(stopNurseBeep); }

    let floorRefs = [];
    function attachFloorListeners(){
      const rowsRef   = ref(db, `${roomPath()}/rows`);
      const timersRef = ref(db, `${roomPath()}/timers`);
      const chunaRef  = ref(db, `${roomPath()}/chuna`);
      floorRefs = [rowsRef, timersRef, chunaRef];

      onValue(rowsRef, (snap) => {
        const rows = snap.val() || {};
        for (let i=1;i<=ROW_COUNT;i++){
          const r  = rows[i] || {};
          const tr = document.getElementById("row-"+i);
          if (!tr) continue;
          const sel = tr.querySelector("select.doctor");
          if (sel && sel.value !== (r.dept||"")) sel.value = r.dept||"";
          tr.style.background = deptColors[r.dept||""] || "";
          const inBtn  = tr.querySelector(".io-btn[data-type='ì…ì›']");
          const outBtn = tr.querySelector(".io-btn[data-type='ì™¸ë˜']");
          if (inBtn && outBtn){ inBtn.classList.toggle("active", r.inout === "ì…ì›"); outBtn.classList.toggle("active", r.inout === "ì™¸ë˜"); }
          const nameTd = tr.children[1];
          if (r.name && nameTd.textContent !== r.name) nameTd.textContent = r.name;
        }
      });

      onValue(timersRef, (snap) => {
        const timers = snap.val() || {};
        Object.entries(timers).forEach(([key, v]) => {
          const st = document.getElementById("status-"+key);
          const tt = document.getElementById("time-"+key);
          const box = document.getElementById("box-"+key);
          if (!st || !tt || !box) return;
          const status = v.status || "ëŒ€ê¸°";
          st.textContent = status;
          st.className = "pill " + (status==="ì§„í–‰" ? "pill-run" : status==="ì™„ë£Œ" ? "pill-done" : "pill-wait");
          box.classList.remove("cell-blink");
          if (intervals[key]) { clearInterval(intervals[key]); intervals[key]=null; }
          if (status === "ì§„í–‰" && v.endAt){
            const tick = () => {
              const remain = Math.max(0, Math.floor((v.endAt - Date.now())/1000));
              tt.textContent = fmt(remain);
              if (remain <= 0){
                clearInterval(intervals[key]); intervals[key]=null;
                st.textContent = "ì™„ë£Œ"; st.className = "pill pill-done";
                tt.textContent = "";
                box.classList.add("cell-blink");
                playBeepFor10Sec_Complete();
                update(ref(db, `${roomPath()}/timers/${key}`), { status: "ì™„ë£Œ", endAt: null, remaining: 0 });
              }
            };
            tick();
            intervals[key] = setInterval(tick, 250);
          } else {
            const base = DEFAULT_MINUTES;
            const remain = (typeof v.remaining === "number" && v.remaining>0) ? v.remaining : (status==="ì™„ë£Œ"?0:base*60);
            tt.textContent = remain>0 ? fmt(remain) : "";
            if (status === "ì™„ë£Œ") box.classList.add("cell-blink");
          }
        });
      });

      onValue(chunaRef, (snap) => {
        const data = snap.val() || {};
        for (let i=1;i<=ROW_COUNT;i++){
          const key = `r${i}_c3`;
          const on = !!(data[key] && data[key].on);
          const st = document.getElementById("status-"+key);
          const oBtn = document.getElementById("ox-on-"+key);
          const xBtn = document.getElementById("ox-off-"+key);
          if (st) st.textContent = on ? "ì§„í–‰" : "ëŒ€ê¸°";
          if (st) st.className = "pill " + (on ? "pill-run" : "pill-wait");
          if (oBtn) oBtn.classList.toggle("ox-on", on);
          if (xBtn) xBtn.classList.toggle("ox-on", !on);
        }
      });
    }
    function teardownFloorListeners(){ floorRefs.forEach(r => off(r)); floorRefs = []; }

    let nurseRefs = [];
    const nurseAggregates = { "ëŒ€í‘œ":false,"ì–‘ë°©":false,"1ê³¼":false,"2ê³¼":false,"3ê³¼":false };
    function attachNurseListeners_Doctor(){
      nurseRefs = FLOORS.map(f => ref(db, `rooms/${f}/nurseCalls`));
      nurseRefs.forEach(rf => onValue(rf, (snap)=>{
        const c = snap.val() || {};
        ["ëŒ€í‘œ","ì–‘ë°©","1ê³¼","2ê³¼","3ê³¼"].forEach(dept=>{
          const on = !!(c[dept] && c[dept].on);
          if (on) nurseAggregates[dept] = true;
        });
        applyNurseAggregateUI();
      }));
    }
    function attachNurseListeners_Nurse(){
      nurseRefs = [ ref(db, `${roomPath()}/nurseCalls`) ];
      onValue(nurseRefs[0], (snap)=>{
        const c = snap.val() || {};
        ["ëŒ€í‘œ","ì–‘ë°©","1ê³¼","2ê³¼","3ê³¼"].forEach(dept=>{
          const btn = document.getElementById("call-"+dept);
          const on  = !!(c[dept] && c[dept].on);
          btn.classList.toggle("on", on);
          btn.classList.toggle("blink-btn", on);
          if (on && !lastCallState[dept]) startNurseBeep(dept);
          else if (!on && lastCallState[dept]) stopNurseBeep(dept);
          lastCallState[dept] = on;
        });
      });
    }
    function detachAllNurseListeners(){ nurseRefs.forEach(r => off(r)); nurseRefs = []; }
    function applyNurseAggregateUI(){
      ["ëŒ€í‘œ","ì–‘ë°©","1ê³¼","2ê³¼","3ê³¼"].forEach(dept=>{
        const btn = document.getElementById("call-"+dept);
        const on  = !!nurseAggregates[dept];
        btn.classList.toggle("on", on);
        btn.classList.toggle("blink-btn", on);
        if (on && !lastCallState[dept]) startNurseBeep(dept);
        else if (!on && lastCallState[dept]) stopNurseBeep(dept);
        lastCallState[dept] = on;
        nurseAggregates[dept] = false;
      });
    }
    function reattachAllNurseListeners(){
      detachAllNurseListeners();
      ["ëŒ€í‘œ","ì–‘ë°©","1ê³¼","2ê³¼","3ê³¼"].forEach(d=>{ nurseAggregates[d]=false; });
      if (role === 'doctor') attachNurseListeners_Doctor();
      else attachNurseListeners_Nurse();
    }
    function fmt(sec){ const m=Math.floor(sec/60), s=sec%60; return `${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`; }

    function buildTable(){
      const tbody = document.getElementById("tableBody"); tbody.innerHTML = "";
      for(let i=1;i<=ROW_COUNT;i++){
        const tr = document.createElement("tr"); tr.id = "row-"+i;
        const docTd = document.createElement("td");
        docTd.innerHTML = `
          <div>
            <select class="doctor" style="width:100%;padding:10px 12px;font-size:18px;border-radius:10px;"
              onchange="changeDoctor(${i}, this.value)">
              <option value="">ì„ íƒ</option>
              <option value="ëŒ€í‘œ">ëŒ€í‘œ</option>
              <option value="ì–‘ë°©">ì–‘ë°©</option>
              <option value="1ê³¼">1ê³¼</option>
              <option value="2ê³¼">2ê³¼</option>
              <option value="3ê³¼">3ê³¼</option>
            </select>
            <div class="io-group">
              <button class="io-btn" data-type="ì…ì›" onclick="setInOut(${i}, 'ì…ì›')">ì…ì›</button>
              <button class="io-btn" data-type="ì™¸ë˜" onclick="setInOut(${i}, 'ì™¸ë˜')">ì™¸ë˜</button>
            </div>
          </div>`;
        tr.appendChild(docTd);

        const nameTd = document.createElement("td");
        nameTd.className = "name-cell";
        nameTd.textContent = `<${i}ë²ˆ ë² ë“œ>`;
        nameTd.contentEditable = true;
        nameTd.addEventListener("blur", () => { update(ref(db, `${roomPath()}/rows/${i}`), { name: nameTd.textContent }); });
        tr.appendChild(nameTd);

        COLS.forEach((colName, j) => {
          const key = `r${i}_c${j}`;
          const td  = document.createElement("td");
          td.innerHTML = `
            <div class="status-box" id="box-${key}" onclick="resetIfDone('${key}')">
              <div class="left-col">
                <span class="pill pill-wait" id="status-${key}">ëŒ€ê¸°</span>
                <span class="time-text" id="time-${key}"></span>
              </div>
              <div class="right-col">
                <button class="mini-btn mini-start" onclick="startTimer('${key}', '${colName}'); event.stopPropagation();">ì§„í–‰</button>
                <button class="mini-btn mini-stop"  onclick="stopTimer('${key}'); event.stopPropagation();">ì¤‘ì§€</button>
                <div class="adjust-box">
                  <button class="btn-adjust" onclick="adjustTime('${key}', 30); event.stopPropagation();">+</button>
                  <button class="btn-adjust" onclick="adjustTime('${key}',-30); event.stopPropagation();">-</button>
                </div>
              </div>
            </div>`;
          tr.appendChild(td);
        });

        const chunaKey = `r${i}_c3`;
        const chunaTd  = document.createElement("td");
        chunaTd.innerHTML = `
          <div class="chuna-box" id="box-${chunaKey}">
            <div class="left-col">
              <span class="pill pill-wait" id="status-${chunaKey}">ëŒ€ê¸°</span>
            </div>
            <div class="ox-group">
              <button class="ox-btn ox-on"  id="ox-on-${chunaKey}"  onclick="toggleChuna('${chunaKey}', true)">O</button>
              <button class="ox-btn ox-off" id="ox-off-${chunaKey}" onclick="toggleChuna('${chunaKey}', false)">X</button>
            </div>
          </div>`;
        tr.appendChild(chunaTd);

        tbody.appendChild(tr);
      }
    }

    buildTable(); attachFloorListeners(); reattachAllNurseListeners();
  </script>
</body>
</html>
